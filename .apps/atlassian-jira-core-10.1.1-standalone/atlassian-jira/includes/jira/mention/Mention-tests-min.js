function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);return"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=new Array(t);a<t;a++)r[a]=e[a];return r}function _iterableToArrayLimit(e,t){var a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var r,n,s,o,i=[],u=!0,l=!1;try{if(s=(a=a.call(e)).next,0===t){if(Object(a)!==a)return;u=!1}else for(;!(u=(r=s.call(a)).done)&&(i.push(r.value),i.length!==t);u=!0);}catch(e){l=!0,n=e}finally{try{if(!u&&null!=a.return&&(o=a.return(),Object(o)!==o))return}finally{if(l)throw n}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}AJS.test.require(["jira.webresources:mentions-feature"],(function(){"use strict";var e=require("jira/mention/mention-matcher"),t=require("jira/mention/mention"),a=require("jquery"),r=[{self:"http://localhost:8090/jira/rest/api/2/user?username=admin",key:"admin",name:"admin",emailAddress:"admin@admin.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/64e1b8d34f425d19e1ee2ea7236d3028?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/64e1b8d34f425d19e1ee2ea7236d3028?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/64e1b8d34f425d19e1ee2ea7236d3028?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/64e1b8d34f425d19e1ee2ea7236d3028?d=mm&s=32"},displayName:"admin",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[{id:"assignee",label:"assignee"},{id:"reporter",label:"reporter"}],highestIssueInvolvementRank:0},{self:"http://localhost:8090/jira/rest/api/2/user?username=axafirfjr",key:"JIRAUSER10640",name:"axafirfjr",emailAddress:"axafirfjr@localdomain.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/82311ba8f074bae9ef3715290ee2136a?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/82311ba8f074bae9ef3715290ee2136a?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/82311ba8f074bae9ef3715290ee2136a?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/82311ba8f074bae9ef3715290ee2136a?d=mm&s=32"},displayName:"Aaflwdgu Xafirfjr",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[]},{self:"http://localhost:8090/jira/rest/api/2/user?username=asumlnczj",key:"JIRAUSER10624",name:"asumlnczj",emailAddress:"asumlnczj@localdomain.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/f549dbd3da17ee50c851f568ca74d05e?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/f549dbd3da17ee50c851f568ca74d05e?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/f549dbd3da17ee50c851f568ca74d05e?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/f549dbd3da17ee50c851f568ca74d05e?d=mm&s=32"},displayName:"Aajegmhy Sumlnczj",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[]},{self:"http://localhost:8090/jira/rest/api/2/user?username=axmyummap",key:"JIRAUSER11091",name:"axmyummap",emailAddress:"axmyummap@localdomain.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/0bf6ef284e3a9328e6078e9a4282e804?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/0bf6ef284e3a9328e6078e9a4282e804?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/0bf6ef284e3a9328e6078e9a4282e804?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/0bf6ef284e3a9328e6078e9a4282e804?d=mm&s=32"},displayName:"Aaomclxu Xmyummap",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[]},{self:"http://localhost:8090/jira/rest/api/2/user?username=ajsvnucxf",key:"JIRAUSER11535",name:"ajsvnucxf",emailAddress:"ajsvnucxf@localdomain.com",avatarUrls:{"48x48":"https://www.gravatar.com/avatar/f491c6f658614f6609a61a36d2528b39?d=mm&s=48","24x24":"https://www.gravatar.com/avatar/f491c6f658614f6609a61a36d2528b39?d=mm&s=24","16x16":"https://www.gravatar.com/avatar/f491c6f658614f6609a61a36d2528b39?d=mm&s=16","32x32":"https://www.gravatar.com/avatar/f491c6f658614f6609a61a36d2528b39?d=mm&s=32"},displayName:"Aarmwrzx Jsvnucxf",active:!0,timeZone:"Australia/Sydney",locale:"en_AU",issueInvolvements:[]}],n=175,s="fred",o="HEK-1",i={isVisible:function(){return!0},layer:function(){return a("#AJS-layer")}},u={items:r};function l(t,a){a||(a=t.length);return e.getUserNameFromCurrentWord(t,a)}module("getUserNameFromCurrentWord - triggers");test("empty searches",(function(){equal(l("@"),"","matching @");equal(l("[@"),"","matching [@");equal(l("[~"),"","matching [~");equal(l("[~@"),"","matching [~@");equal(l("~@"),"","matching ~@")}));test("non-valid syntaxes do not trigger autocomplete",(function(){equal(l("["),null,"matching [");equal(l("[a"),null,"matching [a")}));test("simple search for 'a'",(function(){equal(l("@a"),"a","matching @a");equal(l("[@a"),"a","matching [@a");equal(l("[~a"),"a","matching [~a");equal(l("[~@a"),"a","matching [~@a")}));test("takes the last occurrence of [~ to start the search",(function(){equal(l("[~[~["),"[","should only return data after the last [~")}));test("the @ syntax takes precedence over [~ syntax",(function(){equal(l("[@~"),"~","matching [@~");equal(l("[@~a"),"~a","matching [@~a")}));test("the @ syntax does not match if preceded by alpha-numeric characters",(function(){equal(l("test@a"),null,"matching test@a");equal(l("the quick brown fox jumped over the lazy@dog"),null,"there's an alphanumeric character before the @, so shouldn't match");equal(l("the quick brown fox jumped over the lazy @dog"),"dog","no alphanumeric character before the @, so should search for 'dog'")}));test("the [~ syntax does not match if preceded by alpha-numeric characters",(function(){equal(l("test[~a"),null,"matching test[~a");equal(l("the quick brown fox jumped over the lazy[~dog"),null,"there's an alphanumeric character before the [~, so shouldn't match");equal(l("the quick brown fox jumped over the lazy [~dog"),"dog","no alphanumeric character before the [~, so should search for 'dog'")}));test("the rest",(function(){equal(l("test[@a"),"a","matching test[@a");equal(l("test[@~a"),"~a","matching test[@~a");equal(l("test[~@a"),"a","matching test[~@a");equal(l("a test[@a"),"a","matching a test[@a");equal(l("a test[@~a"),"~a","matching a test[@~a");equal(l("a test[~@a"),"a","matching a test[~@a")}));module("getUserNameFromCurrentWord - query");test("can have multiple words in the query",(function(){equal(l("the quick brown fox jumped over the @lazy dog"),"lazy dog","should return 'lazy dog'");equal(l("the quick brown fox jumped over @the lazy dog"),"the lazy dog","should return 'the lazy dog'")}));test("the query is limited to three words maximum",(function(){var e="the quick brown fox @jumped over the lazy dog";equal(l(e,45),null,"caret is at end of 5th word after the @, so should return null");equal(l(e,41),null,"caret is at end of 4th word after the @, so should return null");equal(l(e,38),null,"caret is inside 4th word after the @, so should return null");equal(l(e,36),"jumped over the","caret is at end of 3rd word after the @, so should return 'jumped over the'")}));test("the query will return multiple words up to and including any whitespace before the 4th word",(function(){var e="the quick brown fox @jumped over the lazy dog";equal(l(e,37),"jumped over the ","caret is just before the 4th word after the @, so should return everything before it (including the whitespace)");equal(l(e,38),null,"caret is just after the 'l' in lazy, which is in the 4th word, so should return null")}));test("trailing whitespace is 'preserved' in the query",(function(){equal(l("the quick brown fox jumped over the @lazy dog  "),"lazy dog  ","should keep the space after 'dog'")}));test("infix whitespace is preserved in the query",(function(){equal(l("jumped over the @lazy   dog"),"lazy   dog","should keep the three spaces between 'lazy' and 'dog'");equal(l("jumped over the @lazy \t\t  dog"),"lazy \t\t  dog","keeps everything between 'lazy' and 'dog'")}));test("carriage return and newline break the query",(function(){var e="jumped over the @lazy\ndog";equal(l(e,25),null,"when the user's caret is on the next line, it returns false");equal(l(e,22),null,"when the user's caret is just after the new line, it returns false");equal(l(e,21),"lazy","when the user's caret is just before the new line (i.e, just after 'lazy'), it will return 'lazy'")}));module("Mention - role help text");function c(e){return!!a(JIRA.Templates.mentionsSuggestions({suggestions:[],activity:!1,query:null,isRolesEnabled:e})).find(".aui-list-section-footer").length}test("help text should be available when roles is enabled",(function(){ok(c(!0))}));test("help text should not be available when roles is not enabled",(function(){ok(!c(!1))}));module("Mention#_indexOfFirstMatch");test("_indexOfFirstMatch",(function(){var e=JIRA.Mention.prototype._indexOfFirstMatch;equal(e("Mike Cannon-Brooks","Br"),12);equal(e("Mike Cannon-Brooks","Bre"),-1);equal(e("Mike Cannon-Brooks","Mi"),0);equal(e("Mike Cannon-Brooks","Cann"),5);equal(e("Mike Cannon-Brooks","Cannon-Brooks"),5);equal(e("James O'Brian","Br"),8);equal(e("James O'Brian","O'Br"),6);equal(e("cat@hat.com","ca"),0);equal(e("cat@hat.com","ha"),4);equal(e("cat@hat.com","at"),-1);equal(e("cat@hat.com","co"),8)}));module("Mentions component",{setup:function(){this.sandbox=sinon.sandbox.create();this.server=this.sandbox.useFakeServer();this.clock=this.sandbox.useFakeTimers()},teardown:function(){this.clock.restore();this.server.restore()}});var d=function(e){return e.split("?")[1].split("&").reduce((function(e,t){var a=_slicedToArray(t.split("="),2),r=a[0],n=a[1];e[r]=n;return e}),{})};test("Debounces calls to server",(function(){var e=new t("HEK-1"),r="<textarea></textarea>";sinon.stub(e,"_getMentionsOffsetTarget",(function(){return a(r)}));e.textarea(r);sinon.stub(e,"_getUserNameFromInput",(function(){return"fred"}));sinon.stub(e,"_getCaretPosition",(function(){return 0}));sinon.stub(e,"_isNewRequestRequired",(function(){return!0}));e._keyUp();e._keyUp();e._keyUp();equal(this.server.requests.length,0,"API was not called instantly");this.clock.tick(n);equal(this.server.requests.length,1,"API was called once")}));[{description:"calls proper URL when feature flag is turned off and issue key is present",issueKey:o,query:s,featureFlag:!1,expectedUrl:"/rest/internal/2/user/mention/search",urlParams:{issueKey:o}},{description:"calls proper URL when feature flag is turned off and issue key is not present",query:s,featureFlag:!1,expectedUrl:"/rest/api/2/user/viewissue/search",urlParams:{username:s}},{description:"calls proper URL when feature flag is turned on and issue key is present",issueKey:o,query:s,featureFlag:!0,expectedUrl:"/rest/internal/2/users/mention",urlParams:{issueKey:o,query:s}},{description:"calls proper URL when feature flag is turned on and issue key is not present",query:s,featureFlag:!0,expectedUrl:"/rest/internal/2/users/mention",urlParams:{query:s}},{description:"calls proper URL when feature flag is turned on and multiple project keys are present",query:s,featureFlag:!0,projectKeys:"AAA,BBB,CCC",expectedUrl:"/rest/internal/2/users/mention",urlParams:{query:s,projectKeys:"AAA%2CBBB%2CCCC"}}].forEach((function(e){test("".concat(e.description),(function(){var r=new t(e.issueKey,e.featureFlag),s='<textarea data-issuekey="'.concat(e.issueKey||"",'" data-project-keys="').concat(e.projectKeys||"",'"></textarea>');sinon.stub(r,"_getMentionsOffsetTarget",(function(){return a(s)}));r.textarea(s);sinon.stub(r,"_getUserNameFromInput",(function(){return e.query}));sinon.stub(r,"_getCaretPosition",(function(){return 0}));sinon.stub(r,"_isNewRequestRequired",(function(){return!0}));r._keyUp();this.server.requests=[];this.clock.tick(n);var o=this.server.requests[0].url;ok(o.includes(e.expectedUrl),e.description+" - proper URL is used");equal(d(o).maxResults,5,e.description+" - maxResults is set properly");Object.entries(e.urlParams).forEach((function(t){var a=_slicedToArray(t,2),r=a[0],n=a[1];equal(d(o)[r],n,e.description+" - ".concat(r," is set properly"))}))}))}));test("Uses queryCache to display results",(function(){var e=new t("HEK-1"),s="<textarea></textarea>",o="admin";sinon.stub(e,"_getUserNameFromInput",(function(){return o}));sinon.stub(e,"_getCaretPosition",(function(){return 1}));sinon.stub(e,"_isNewRequestRequired",(function(){return!0}));sinon.stub(e,"_getMentionsOffsetTarget",(function(){return a(s)}));var i=sinon.spy(e,"updateSuggestions");e.textarea(s);equal(e.dataSource.matcher(),!1,"matcher is not returning results");e._keyUp();this.clock.tick(n);this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify(r)]);this.sandbox.server.respond();var u,l=(u=i.secondCall.args[0],Array.from(u.find(".aui-list-item-link").map((function(e,t){return a(t).attr("rel")}))));deepEqual(l,r.map((function(e){return e.name})),"shows results in backend order");e._keyUp();this.clock.tick(n);equal(this.server.requests.length,1,"server is not polled again for the same query");o="a";e._keyUp();this.clock.tick(n);equal(this.server.requests.length,2,"server is polled even if it could populate dropdown from cache")}));test("The assistive container should update his content properly",(function(e){var n=e.async(),s=new t("HEK-1");s.layerController=i;s.listController=u;var o=a('<div id="AJS-layer"></div>').append(JIRA.Templates.mentionsSuggestions({suggestions:r,query:"admin",activity:!0,isRolesEnabled:!1,useDefaultAvatar:!0}));a("#qunit-fixture").append(o);s.updateMentionsStatus(!0);new Promise((function(e){return setTimeout((function(){e()}),2e3)})).then((function(){equal("jira.mentions.dropdown.announcement jira.mentions.results.amount jira.mentions.selected.user",a("#AJS-layer").find('div.assistive[role="status"]').text(),"Assistive text should be set properly.");n()}));this.clock.tick(2e3)}))}));