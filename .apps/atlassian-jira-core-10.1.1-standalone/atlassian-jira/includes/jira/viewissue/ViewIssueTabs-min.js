define("jira/viewissue/tabs",["wrm/require","jira/util/logger","jquery","jira/jquery/deferred","jira/util/data/meta","jira/dialog/form-dialog2","jira/ajs/ajax/smart-ajax","jira/userhover/userhover","jira/viewissue/tabs/analytics"],(function(t,e,a,i,n,r,s,o,u){"use strict";var l,c,d,f=JIRA.Templates.Issue.Tabs,h=!1!==n.get("viewissue-use-history-api"),v="ajax-activity-content",m="#activitymodule div.mod-content",p="."+v,g=[];function b(t){t=t||document;a.each(g,(function(e,a){a(t)}))}function y(t){a("#issue-tabs li").each((function(){var e=a(this),i=e.data("key"),n=e.data("label");if(i===t){e.addClass("active");e.html(f.label({text:n}))}else{e.removeClass("active");var r=e.data("id"),s=e.data("href");e.html(f.tab({id:r,href:s,linkClass:v,text:n}))}}));j(a("#issue-tabs"))}function j(e){var i=a(e).find("li.active").data("key");a(e).find(p).click((function(e){document.getElementById("activitymodule").classList.add("updating");var n=a(this),r=n.hasClass("issue-activity-sort-link"),s=a("#issue-tabs .active-tab").data("id"),o=n.attr("id"),u=n.attr("aria-controls");if(r)t("wr!com.atlassian.jira.jira-frontend-plugin:entrypoint-activityTabs").then((function(){require("jira/activity-tabs/items-lazy-loader").then((function(t){t.getRegisteredTabsIds().includes(s)?document.getElementById("activitymodule").classList.remove("updating"):w(n,i,e)}))}));else{w(n,i,e);var l=a(".issuePanelWrapper");l.attr("aria-labelledby",o);l.attr("id",u)}}))}function w(t,n,o){var f=function(t,e){var a=t.pageX,i=t.pageY,n=e.offset(),r=e.outerWidth(),s=e.outerHeight();return 0===a&&0===i||!(a>=n.left&&a<=n.left+r&&i>=n.top&&i<=n.top+s)}(o,t),v=t.parent().data("key"),p=o.metaKey;v?u.tabClicked(t,p,f):u.buttonClicked(t,p,f);if(!p){o.preventDefault();v&&function(t){y(t)}(v);(function(t,n){var o=i();d&&d.abort();var u=s.makeRequest({jqueryAjaxFn:h?a.pjax:a.ajax,headers:{"X-PJAX":!0},container:m,url:n,timeout:null,complete:function(i,n,u){if("abort"!==n){d=null;if(!u.successful){(u.status<300||u.status>=400)&&function(t,e){var a=new r({id:"issue-tab-error-dialog",widthClass:"small",content:s.buildDialogErrorContent(t,!1)});y(e);c.show();a.show()}(u,t);return}var l=a(this.container),f=document.createElement("div");f.innerHTML=u.data;var v=document.createDocumentFragment().appendChild(f);h||function(t,e){c=A();var i=e.querySelectorAll(".tabwrap"),n=t.find(".tabwrap"),r=a(e.querySelectorAll("#issue_actions_container")).contents(),s=c.contents();if(i.length&&n.length&&r.length&&s.length){n.replaceWith(i);c.stop(!0,!0);var o=c.height();c.append(r);var u=c.height()-o,l=o-u;if(l>0){c.css("height",u+l);s.remove();!function(t,e){var a=150,i=800,n=Math.min(e/i*1e3,1e3);setTimeout((function(){c.animate({height:t+1},n,"easeOutQuart",(function(){c.css("height","auto")}))}),a)}(u,l)}else c.empty().append(r);a(e.querySelectorAll("script")).each((function(){a.globalEval(this.text||this.textContent||this.innerHTML||"")}))}else t.empty().append(e)}(l,v);e.trace("jira.issue.tab.loaded");o.resolve(l)}}});a(u).throbber({target:l});d=u;return o})(n,t.data("ajax")||t.attr("href")).done((function(e){document.getElementById("activitymodule").classList.remove("updating");if(f)if(v){var a=e.find("#"+t.attr("id"));a.length&&a.focus()}else{var i=e.find(".sortwrap > :first-child");i.length&&i.focus()}})).done(b)}}function x(t){a.inArray(t,g)<0&&g.push(t)}function A(){return a(m).find("#issue_actions_container")}x((function(t){var e=a(t).find(".issuePanelWrapper"),i=A();c=i.length?i:c;l=e.length?e:l}));x((function(t){!h||a.support.pjax?j(t):function(t){a(t).find(p).each((function(){var t=a(this);t.attr("href",t.attr("href")+"#issue-tabs")}))}(t)}));x((function(t){a(t).bind("moveToFinished",(function(t,e){a("a.twixi:visible",e).focus()}))}));x(o);x((function(t){t.find("time.livestamp").livestamp()}));x((function(){var t=a(".menu-item a");a(document).on("keydown",(function(e){var i=a(document.activeElement);if(i.is(".menu-item a")){var n=t.index(i),r=e.key;if("ArrowRight"===r||"ArrowLeft"===r){var s;"ArrowRight"===r?s=(n+1)%t.length:"ArrowLeft"===r&&(s=(n-1+t.length)%t.length);t.eq(s).focus();e.preventDefault();t.attr("tabindex","-1");t.eq(s).attr("tabindex","0")}}}))}));return{onTabReady:x,domReady:b}}));AJS.namespace("JIRA.ViewIssueTabs",null,require("jira/viewissue/tabs"));