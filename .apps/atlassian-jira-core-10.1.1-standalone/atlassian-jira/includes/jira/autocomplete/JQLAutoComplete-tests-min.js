AJS.test.require(["jira.webresources:jqlautocomplete"],(function(){"use strict";var e,r=require("jira/jql/jql-parser"),o=require("jira/autocomplete/jql-autocomplete"),i=require("jira/terminology-feature-service"),t=require("jquery"),a="PARSE_FAIL",n="SUCCESS",s="{}*/%+$#@?;",p=["abort","access","add","after","alias","all","alter","and","any","as","asc"],l=["greater","for","privileges","float","validate","distinct","of","break","defaults","byte","initial","file","noaudit","empty","on","false","boolean","right","option","decrement","limit","else","increment","fetch","equals","or","number","table","like","create","row","declare","not","trans","asc","start","session","then","view","strict","explain","go","unique","desc","raise","exclusive","before","next","inout","goto","date","nowait","escape","mode","character","rownum","union","encoding","delete","current","whenever","left","do","null","end","min","trigger","intersection","define","max","previous","integer","sqrt","return","true","checkpoint","divide","join","access","alter","field","delimiter","string","exists","modulo","having","public","insert","abort","uid","to","last","grant","count","transaction","synonym","inner","char","drop","rename","collate","by","where","long","identified","prior","function","revoke","after","remainder","values","more","commit","when","any","power","notin","returns","avg","index","execute","minus","select","int","double","size","rows","and","difference","input","default","isempty","intersect","column","exec","output","cf","update","raw","connect","set","catch","sum","object","from","add","collation","while","share","order","isnull","if","less","between","all","with","is","check","alias","resource","lock","into","modify","audit","as","multiply","in","decimal","begin","subtract","immediate","outer","continue","group","user","rowid","first"];function u(e,o){test("test query: "+e,(function(){var i=r(l).parse(e);o===a?ok(i.parseError,"Expected parsing to fail"):ok(!i.parseError,"Expected parsing to be successful")}))}module("Test parser");u('priority = "qwerty"',n);u('priority = "qwerty"',n);u('priority="qwerty"',n);u("priority=qwerty",n);u("  priority=qwerty  ",n);u("priority=     qwerty order      by priority, other",n);u("coolness >= awesome",n);u("coolness > awesome",n);u("coolness < awesome",n);u("coolness <= awesome",n);u("coolness        !=       awesome order     by     coolness desc",n);u('language in (java, c, "python2")',n);u('languagein   IN    (   java, c     , "python2")',n);u('inlanguage in (java, c, "python2")',n);u('pri in (java,c,"python2")',n);u("pri in(java)",n);u("pri In(java)",n);u("pri iN(java)",n);u('language not in (java, c, "python2")',n);u('languagein  NOT   IN    (   java, c     , "python2")',n);u('inlanguage not in (java, c, "python2")',n);u('pri NOT in (java,c,"python2")',n);u("pri not in(java)",n);u("pri NoT In(java)",n);u("pri nOT iN(java)",n);u("pri ~ stuff",n);u("pri~stuff",n);u("pri ~ 12",n);u("pri~12",n);u('pri ~ ("stuff", 12)',n);u("pri !~ stuff",n);u("pri!~stuff",n);u("pri !~ 12",n);u("pri!~12",n);u('pri !~ ("stuff", 12)',n);u("pri IS stuff",n);u("pri is stuff",n);u("pri IS EMPTY",n);u("pri IS NOT stuff",n);u("pri IS not stuff",n);u("pri is Not stuff",n);u("pri is not stuff",n);u("pri iN((java), duke)",n);u("priority = 12345",n);u("priority = -12345",n);u('priority = "12a345"',n);u("priority = 12345a",n);u("cf[12345] = 12345a",n);u("Cf  [ 0005 ] = x",n);u('priority = "12345"',n);u('priority="12a345"',n);u("testfield = EMPTY",n);u("testfield = empty",n);u("testfield = NULL",n);u("testfield = null",n);u('testfield = "null"',n);u('testfield = "NULL"',n);u('testfield = "EMPTY"',n);u('testfield = "empty"',n);u('priority = "a big string ~ != foo and priority = haha "',n);u('priority = ""',n);u("prior\\'ty = testvalue",n);u("priority\\ ty=testvalue",n);u("priority⻥ > 6",n);u("priori\\nty\\u2ee5 > 6",n);u("\\     < 38",n);u('"this is a strange field " = google',n);u("\"don't\" = 'true'",n);u('"don\\"t" = \'false\'',n);u("'don\"t' = 'false'",n);u("'cf[1220]' = abc",n);u("'cf' = abc",n);u("10245948 = abc      order          by 10245948",n);u("-10245948 = abc",n);u("new\\nline = abc",n);u("some\\u0082control = abc  order by some\\u0082control",n);u("b = ''",n);u("b = \\ ",n);u("b = don\\'t\\ stop\\ me\\ now",n);u("b = ⻥",n);u("b = \\u2EE5jkdfskjfd",n);u("b not in 'jack says, \"Hello World!\"'",n);u("b not in 'jack says, \\'Hello World!\\''",n);u("b not in \"jack says, 'Hello World!'\"",n);u('b not in "jack says, \\"Hello World!\'\\""',n);u('b not in "jack says, \\tnothing"',n);u("bad ~ wt\\u007f",n);u('priority = "a \\n new \\r line"',n);u('priority = "Tab:\\t NewLine:\\n Carrage Return:\\r"',n);u('priority = "Quote:\\" Single:\\\' Back Slash:\\\\ Space:\\ "',n);u('priority = "Unicode: \\ufeeF1 Unicode2: \\u6EEF"',n);u("priority = 'Escape\" don\\'t'",n);u('priority = "Escape\' don\\"t"',n);u("priority = higherThan(Major)",n);u('priority In     randomName(Major, Minor,      "cool", -65784)',n);u("priority    >=    randomName()",n);u("pri not in fun(name\\u0082e)",n);u("a = func\\'  ()",n);u("a = fu\\\"nc\\'()",n);u("a=function\\ name(  )",n);u("a = ⻥()",n);u("a = somereallystrangestring\\u2ee5()",n);u('version <= "affected\\ versions"(   )',n);u('version <= "affected\\ versio\'ns"(   )',n);u('version <= "affected versio\\"ns"(   )',n);u("version <= 'my messed up versio\\'ns'     (   )",n);u("version <= 'my m\\nessed up\\ versio\"ns'     (   )",n);u("version <= 4759879855`(   )",n);u("version <= 4759879(   )",n);u("version = badname\\u0091",n);u("a=b&c=d",n);u("a=b&&c=d",n);u("a=b|c=d",n);u("a=b||c=d",n);u("a<b",n);u("a>b",n);u("a~b",n);u("priority = major and foo > bar()",n);u("priority = majorand and foo>bar()",n);u("priority = major and foo > bar()",n);u("priority != major    and      foo >      bar()",n);u("priority != major    &&      foo >      bar()",n);u("priority != andmajor    &      foo >      bar()",n);u("priority != andmajor    and      foo >      bar() order by priority     DESC,      foo",n);u("a =b",n);u("a !=b",n);u("a >=b",n);u("a <=b",n);u("a !~b",n);u("a ~b",n);u("priority = major or foo > bar()",n);u("priority = major or foo > bar()",n);u("priority = major or foo > bar() or priority = minor",n);u("priority = major || foo > bar() | priority = minor",n);u("priority = major or foo > bar() || priority = minor",n);u("priority = major and foo > bar(1,2,3) or priority = minor and baz != 1234",n);u("priority =     major AND foo > bar(1,2,3) oR priority = minor and baz != 1234",n);u("priority=major and foo>bar(1,2,3)|| priority=minor  and  baz!=1234",n);u("priority = major AND foo > bar(1,2,3) Or priority = minor AND baz != 1234",n);u("priority = major && foo > bar(1,2,3) AND priority = minor and baz != 1234",n);u("priority = major and (foo > bar(1,2,3) OR priority = minor) and baz != 1234",n);u("priority = major or (foo > bar(1,2,3) or priority = minor) and baz != 1234",n);u("not priority = major or foo > bar() or priority = minor",n);u('not priority = major or foo > bar() AnD priority="minor"',n);u('not priority = major or not foo > bar() AnD priority="minor"',n);u('not (priority = major or not foo > bar()) AnD priority="minor"',n);u('! (priority = major or ! foo > bar()) AnD priority="minor"',n);u("! (priority changed from major or ! foo > bar()) AnD priority changed to minor",n);u('not not (not priority = major or     foo >bar()) and         priority="minor"',n);for(e=0;e<11;e++)u("'"+("test"+s.charAt(e)+"dfjd")+"' = 'good'",n);u("order by crap",n);u("order by crap  DESC",n);u("order by crap  ASC",n);u("",n);u('affectedVersion = "New Version 1" order by affectedVersion         ASC,         affectedVersion       DESC, cf[1234]  DESC    ',n);u('(not (resolutiondate <= "2008-01-01") and (type in (Improvement)) or "Priority for beta phase" = 3) and\nassignee = currentUser() order by status',n);u('(not (resolutiondate <= "2008-01-01") and (type in (Improvement)) or "Priority for beta phase" = 3) or\nassignee = currentUser() order by status',n);u('(not (resolutiondate <= "2008-01-01") and (type in (Improvement)) or "Priority for beta phase" = 3) and not\nassignee = currentUser() order by status',n);u("issue.property[x]=y",n);u("issue.property[x.y].test.path = y",n);u("issue.property[x.y].test.path = y.a",n);u("issue.property = y",a);u("issue.property",a);u("issue.property[.x] = y",a);u("issue.property[x] = x",n);u("issue.property[issue.status] = resolved",n);u('ISSUE.property["issue.status"] = resolved',n);u("issue.property['issue.status'] = resolved",n);u("issue.property     ['issue.status'] = resolved",n);u("issue.property['1@4s'] = resolved",n);u("issue.property[1234] = resolved",n);u("issue.property[-1234] = resolved",n);u("issue.property.x = y",a);u("issue.ProPeRty['-@,@'] = resolved",n);u("comment.prop[author]= filip",a);u("comment.prop[author]..a= filip",a);u("version = 1.2.3",n);u("       ",a);u("foo",a);u("foo=",a);u("=",a);u("!=",a);u("foo bar and 78foo = bar",a);u("and and",a);u("a=b a=b",a);u("foo=bar and",a);u("foo=bar and and",a);u("foo=bar and 78foo",a);u("foo=bar and 78foo=",a);u("foo=bar and \n78foo",a);u("foo=bar and 78foo brenden and a=b",a);u("foo=bar and \n78foo brenden and a=b",a);u("foo=bar and not",a);u("foo=bar and not foo =",a);u("not",a);u("not not",a);u("a=b and not not=b",a);u("a=b not a=b",a);u("(",a);u("abc = ()",a);u("abc ~ ()",a);u("abc = )foo(",a);u("abc in (foo",a);u("abc in (foo(",a);u("abc IN ((foo)",a);u("abc in (foo))",a);u("abc in ((fee, fie, foe, fum), 787, (34, (45))",a);u("priority = 12345=== not p jfkff fjfjfj",a);u("priority = 12345 jfkff fjfjfj",a);u("priority=a jfkff=fjfjfj",a);u("priority=12345 jfkff=fjfjfj",a);u("a=b ,b",a);u("a=b,b",a);u("a inb",a);u("a isb",a);u("a is notb",a);u("a not inb",a);for(e=0;e<p.length;e++){u(p[e]+" = stuff",a);u("stuff = "+p[e],a)}u("cf[1234 = x",a);u("cf1234] = x",a);u("cf[z123] = x",a);u("cf[-123] = x",a);u("cf[] = x",a);u("[54] = x",a);u("pri notin (x)",a);u("pri isnot empty",a);u("pri ^ empty",a);u("pri ! in (test)",a);u("pri is ! empty",a);u('priority = """',a);u('priority = "',a);u("priority = '''",a);u("priority = '",a);u("what = hrejw'ewjrhejkw",a);u('wh"at = hrejwewjrhejkw',a);u("'' = bad",a);u('"" = bad',a);u("a = ''()",a);u('b = ""()',a);u("test = case\\",a);u("test = case\\k",a);u("test = case\\u",a);u("test = case\\u278q",a);u("test = case\\u27",a);u("test = case\\u-998",a);u("test = case order by \\u-998",a);u("test = case\\uzzzz",a);u("test = case\\u278qzzzz",a);u("test = case\\u27zzzzz",a);u("tecase\\u-998zzzzz",a);u("case order by \\u-998zzzzz",a);u("cf = brenden",a);u("cf = broken",a);u("\0iuyiuyiu",a);u("aa = order by ",a);u("cont\nrol = ''",a);u("control = f\run()",a);u("a = b order by",a);u("a = b order bya",a);u("a = b order",a);u("a = b order BY abc desc, ",a);u("a = b order BY abc desc,qq,",a);u("a = b order BY abc qq asc,",a);u("a = b ANDaffectedVersion=hello",a);u("a = b ORaffectedVersion=hello",a);u("a = b ORNOTaffectedVersion=hello",a);for(e=0;e<11;e++)u("test"+s.charAt(e)+"dfjd = 'bad'",a);u("f\n = \n \n abc *",a);u("f *= abc",a);var c=[{auto:!0,cfid:"cf[10008]",displayName:"Sprint - cf[10008]",operators:["=","!=","in","not in","is","is not"],orderable:!0,searchable:!0,types:["com.atlassian.greenhopper.service.sprint.Sprint"],value:"Sprint"},{auto:!0,cfid:"cf[10008]",displayName:"Potato (Sprint) - cf[10008]",operators:["=","!=","in","not in","is","is not"],orderable:!0,searchable:!0,types:["com.atlassian.greenhopper.service.sprint.Sprint"],value:"Sprint"},{cfid:"cf[10006]",displayName:"Epic Colour - cf[10006]",operators:["=","!=","in","not in","is","is not"],orderable:!0,searchable:!0,types:["java.lang.String"],value:"Epic Colour"},{cfid:"cf[10006]",displayName:"Orange Colour (Epic Colour) - cf[10006]",operators:["=","!=","in","not in","is","is not"],orderable:!0,searchable:!0,types:["java.lang.String"],value:"Epic Colour"},{auto:!0,displayName:"issuetype",operators:["=","!=","in","not in","is","is not"],orderable:!0,searchable:!0,types:["com.atlassian.jira.issue.issuetype.IssueType"],value:"issuetype"}],f=[{originalName:"sprint",newName:"Potato",newNamePlural:"Buggies"},{originalName:"epic",newName:"Orange",newNamePlural:"Oranges"}];module("Terminology Hint",{setup:function(){var e=this,r=t('<textarea id="jql-search"/>');this.sandbox=sinon.sandbox.create();this.clock=this.sandbox.useFakeTimers();this.server=this.sandbox.useFakeServer();this.server.autoRespond=!0;this.server.respondWith(new RegExp("/jql/autocompletedata/suggestions\\?fieldName=issuetype&fieldValue=(.*?)&_=\\d*$"),(function(e,r){var o=r?'{"results":[{"value":"Epic","displayName":"<b>Or</b>ange (Epic)"}]}':'{"results":[{"value":"Bug","displayName":"Bug"},{"value":"Epic","displayName":"Epic"},{"value":"Epic","displayName":"Orange (Epic)"},{"value":"Story","displayName":"Story"},{"value":"Sub-task","displayName":"Sub-task"},{"value":"Task","displayName":"Task"}]}';e.respond(200,{"Content-Type":"application/json"},o)}));this.isTerminologyActive=!0;this.sandbox.stub(i,"isTerminologyActiveForUser",(function(){return e.isTerminologyActive}));this.sandbox.stub(i,"getTerminologyEntries").returns(f);this.$fixture=t("#qunit-fixture");r.appendTo(this.$fixture)},teardown:function(){this.sandbox.restore()},initializeJQLAutocomplete:function(e){this.jqlAutoComplete=new o({fieldID:"jql-search",parser:new r(l),jqlFieldNames:c,jqlFunctionNames:[],suggestionsLimit:e});this.jqlAutoComplete.buildResponseContainer()}});test("does not display terminology hint when terminology is not active",(function(){this.isTerminologyActive=!1;this.initializeJQLAutocomplete();this.jqlAutoComplete.dispatcher("bug");notOk(this.$fixture.find(".terminology-help-container").length)}));test("displays terminology hint when a single term has matching suggestions",(function(){this.initializeJQLAutocomplete(2);this.jqlAutoComplete.dispatcher("bug");var e=this.$fixture.find(".terminology-help-container"),r=e.find("p.syntax-help span").text();ok(e.length);equal(r,"jira.terminology.jqlautocomplete.hint.single")}));test("displays terminology hint for epic and sprints combined when there are matching suggestions",(function(){this.initializeJQLAutocomplete();this.jqlAutoComplete.dispatcher("lol");var e=this.$fixture.find(".terminology-help-container"),r=e.find("p.syntax-help span").text();ok(e.length);equal(r,"jira.terminology.jqlautocomplete.hint.multiple")}));test("displays terminology hint for issuetype value suggestions",(function(){this.initializeJQLAutocomplete();this.jqlAutoComplete.field.val("issuetype = ");this.jqlAutoComplete.dispatcher("issuetype = ");this.clock.tick(50);var e=this.$fixture.find(".terminology-help-container"),r=e.find("p.syntax-help span").text();ok(e.length);equal(r,"jira.terminology.jqlautocomplete.hint.single")}));test("displays terminology hint while filtering issuetype value suggestions",(function(){this.initializeJQLAutocomplete();this.jqlAutoComplete.field.val("issuetype = Or");this.jqlAutoComplete.dispatcher("issuetype = Or");this.clock.tick(50);var e=this.$fixture.find(".terminology-help-container"),r=e.find("p.syntax-help span").text();ok(e.length);equal(r,"jira.terminology.jqlautocomplete.hint.single")}))}));