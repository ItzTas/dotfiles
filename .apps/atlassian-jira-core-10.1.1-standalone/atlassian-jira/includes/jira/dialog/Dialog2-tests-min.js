AJS.test.require(["jira.webresources:jira-global","jira.webresources:jira-dialog-core-2"],(function(){"use strict";var t=require("jquery"),e=require("underscore"),i=require("jira/dialog/dialog2"),o=require("jira/dialog/dialog-stack"),n=function(e,o){var n=t("<div>").css({height:"200px"}).append(t("<h2>").text(e)),a={content:function(t){s.contentCall++;return t(n)},height:"200px",windowTitle:e,id:e},s=new i(t.extend(a,o));s.isVisible=function(){return n.is(":visible")};s.contentCall=0;s.title=e;return s},a=function(e,i){return function(o){if(o){var n=o.title;ok(o.isVisible(),n+" visible?");strictEqual(document.title,n,"Title correctly set to '"+n+"'.");ok(0===t(".jira-page-loading-indicator").length,"Throbber is removed when dialog is displayed")}else strictEqual(document.title,i,"Title correctly reset.");for(var a=0;a<e.length;a++)e[a]!==o&&ok((s=e[a],l=o,!s.$popup||!s.isVisible()||s.$popup.css("z-index")<l.$popup.css("z-index")),e[a].title+" not visible?");var s,l}};module("Dialog Tests",{teardown:function(){t("."+i.ClassNames.DIALOG).remove()}});test("Stacks dialogs",(function(){var t=n("Dialog3",{stacked:!0}),e=n("Dialog2",{stacked:!0}),i=n("Dialog1",{stacked:!0}),o=[i,e,t],s=document.title,l=document.title="Stacked Dialogs Test",d=a(o,l),r=function(t){return function(){for(var e=0;e<arguments.length;e++){var i=t[e];strictEqual(i.contentCall,arguments[e],"Content refreshed on '"+i.title+"' "+arguments[e]+" times?")}}}(o);i.show();d(i);r(1,0,0);e.show();d(e);r(1,1,0);t.show();d(t);r(1,1,1);t.hide();d(e);r(1,1,1);t.show();d(t);r(1,1,2);t.hide();d(e);r(1,1,2);e.hide();d(i);r(1,1,2);i.hide();d(null);r(1,1,2);e.show();d(e);r(1,2,2);e.hide();d(null);r(1,2,2);t.show();d(t);r(1,2,3);i.show();d(i);r(2,2,3);e.show();d(e);r(2,3,3);e.hide();d(i);r(2,3,3);i.hide();d(t);r(2,3,3);e.show();d(e);r(2,4,3);e.hide();d(t);r(2,4,3);t.hide();d(null);r(2,4,3);document.title=s}));test("Test Simple Dialog Title Change",(function(){var t=n("Dialog1"),e=n("Dialog2"),i=document.title,o=document.title="Test Dialog Title",a=function(t){t?strictEqual(document.title,t.title,t.title+" title correct?"):strictEqual(document.title,o,"Original Title Restored?")};t.show();a(t);e.show();a(e);e.hide();a(null);t.show();a(t);e.show();a(e);t.show();a(t);t.hide();a(null);document.title=i}));test("Test redirect instructions",(function(){var t=n("Dialog1"),e={},i={getResponseHeader:function(t){return e[t]}},o=t._detectRedirectInstructions(i);deepEqual(o,{serverIsDone:!1,redirectUrl:""},"No header");e["X-Atlassian-Dialog-Control"]="DONE";o=t._detectRedirectInstructions(i);deepEqual(o,{serverIsDone:!0,redirectUrl:""},"DONE header");e["X-Atlassian-Dialog-Control"]="redirect:http://localhost.com";o=t._detectRedirectInstructions(i);deepEqual(o,{serverIsDone:!0,redirectUrl:"http://localhost.com"},"Redirect Header");e["X-Atlassian-Dialog-Control"]="permissionviolation";o=t._detectRedirectInstructions(i);deepEqual(o,{serverIsDone:!0,redirectUrl:window.location.href},"Permision Voilation")}));module("Dialog headers",{setup:function(){this.$content=t("<p>Practically empty</p>");this.dialog=new i({content:this.$content})},teardown:function(){this.dialog.hide();this.$content.remove()}});test("Can provide plain-text for the heading",(function(){var t="This is my dialog heading. It is made from win and awesome.";this.dialog.addHeading(t);notEqual(this.dialog.get$popupHeading().text().indexOf(t),-1,"The title text should be present in the dialog")}));test("heading contents are placed inside known container",(function(){var t="Quite full";this.dialog.addHeading(t);var e=this.dialog.$popup.find(i.getSelector("HEADING_AREA"));equal(e.text(),t,"The dialog's heading is inside an element with the HTML class from JIRA.Dialog.ClassNames.HEADING_AREA");equal(e.find("h2").size(),1,"The dialog's heading is contained within an h2 element.")}));test("Can provide HTML for the heading",(function(){var t="One flew <i>over</i> the <strong>cuckoo's</strong> nest";this.dialog.addHeading(t);var e=this.dialog.$popup.find(i.getSelector("HEADING_AREA"));equal(e.find("h2").html(),t,"HTML is preserved when added to the dialog heading")}));test("H2 is placed first inside the heading",(function(){this.dialog.addHeading("<h2>Dialog title</h2><div>Some additional stuff</div>");var t=this.dialog.$popup.find(i.getSelector("HEADING_AREA"));equal(t.find(":first-child").prop("tagName"),"H2","H2 is the first element in the heading")}));test("H2 is placed first inside the heading regardless the order of elements provided",(function(){this.dialog.addHeading("<div>Some additional stuff</div><h2>Dialog title</h2>");var t=this.dialog.$popup.find(i.getSelector("HEADING_AREA"));equal(t.find(":first-child").prop("tagName"),"H2","H2 is the first element in the heading")}));module("Dialog resources",{setup:function(){this.sandbox=sinon.sandbox.create();var e=t("<div>");this.dialogOptions={resources:["resource1","resource2"],contexts:["context1","context2"],content:function(t){return t(e)}};this.context=AJS.test.mockableModuleContext();this.requireDeferred=new t.Deferred;this.wrmRequire=this.sandbox.stub();this.context.mock("wrm/require",this.wrmRequire);this.Dialog=this.context.require("jira/dialog/dialog");this.WRMDialog=this.Dialog.extend({defineResources:function(){this._super.apply(this,arguments);(this.options.resources||[]).forEach((function(t){this.requireResource(t)}),this);(this.options.contexts||[]).forEach((function(t){this.requireContext(t)}),this)}})},teardown:function(){this.sandbox.restore()}});test("New dialog instance will not prefetch resources in constructor when prefetchResources field is not true",(function(){new this.WRMDialog(this.dialogOptions);ok(this.wrmRequire.notCalled,"require not called")}));test("New dialog instance will prefetch resources in constructor when prefetchResources field is true",(function(){new this.WRMDialog(e.extend(this.dialogOptions,{prefetchResources:!0}));ok(this.wrmRequire.calledOnce,"require called once");deepEqual(this.wrmRequire.getCall(0).args[0],["wr!resource1","wr!resource2","wrc!context1","wrc!context2"],"WRM.require called with proper args")}));test("Show will not download resources if none specified",(function(){var t=new this.WRMDialog;ok(this.wrmRequire.notCalled,"require not called after constructor");t.show();ok(this.wrmRequire.notCalled,"require not called after show");t.hide()}));test("Show will download resources once if specified",(function(){this.wrmRequire.returns(this.requireDeferred);var t=new this.WRMDialog(this.dialogOptions);ok(this.wrmRequire.notCalled,"require not called after constructor");t.show();ok(this.wrmRequire.calledOnce,"require called once");deepEqual(this.wrmRequire.getCall(0).args[0],["wr!resource1","wr!resource2","wrc!context1","wrc!context2"],"WRM.require called with proper args");t.hide();t.show();ok(this.wrmRequire.calledOnce,"require called once");t.hide()}));test("Does not show dialog until resources resolved",(function(){this.wrmRequire.returns(this.requireDeferred);var t=new this.WRMDialog(this.dialogOptions),e=this.sandbox.spy(t,"_onShowContent");ok(this.wrmRequire.notCalled,"require not called after constructor");t.show();ok(this.wrmRequire.calledOnce,"require called once");ok(e.notCalled);this.requireDeferred.resolve();ok(e.calledOnce,"showContent called after resources resolve");t.hide()}));test("Dialog constructor should call options defineResources with itself in scope",(function(){var t=this.sandbox.stub(),e=new this.Dialog({defineResources:t});ok(t.calledOnce,"defineResources was called once");deepEqual(t.getCall(0).thisValue,e,"defineResources called with dialog as this.")}));module("setContent",{teardown:function(){this.dialog.hide();this.$content.remove()}});test("should convert legacy footer to the new footer (AUI Dialog2)",(function(){this.$content=t('<div>Dialog<div class="buttons">Legacy footer</div></div>');var e=this.$content.find(".buttons");this.dialog=new i({content:this.$content});this.dialog.show();var o=this.dialog.$popup;equal(o.children().length,3,"Dialog contains three child elements");var n=o.children().get(2);equal(n.tagName,"DIV","Footer is created and put as the last child of the dialog");equal(n.className,"aui-dialog2-footer","Footer has correct class name");ok(t(n).children().get(0).isEqualNode(e[0]),"Footer has correct content")}));test("should promote footer outside main content area",(function(){this.$content=t('<div>Dialog content<div class="aui-dialog2-footer">AUI Dialog2 footer</div></div>');var e=this.$content.find(".aui-dialog2-footer");this.dialog=new i({content:this.$content});this.dialog.show();var o=this.dialog.$popup;equal(o.children().length,3,"Dialog contains three child elements");var n=o.children().get(2);ok(n.isEqualNode(e[0]),"Footer is promoted after dialog main content area")}));test("should promote heading outside main content area",(function(){this.$content=t('<div>Dialog content<div class="aui-dialog2-header jira-dialog-core-heading">AUI Dialog2 header</div></div>');var e=this.$content.find(".aui-dialog2-header");this.dialog=new i({content:this.$content});this.dialog.show();var o=this.dialog.$popup;equal(o.children().length,2,"Dialog contains two child elements");var n=o.children().get(0);ok(n.isEqualNode(e[0]),"Header is promoted before dialog main content area")}));test("should pull nested dialog content to the main content area",(function(){this.$content=t('<div>Dialog content<div class="aui-dialog2-content jira-dialog-core-content"><div>AUI Dialog2 content</div></div></div>');this.dialog=new i({content:this.$content});this.dialog.show();var e=this.dialog.$popup;equal(e.children().length,2,"Dialog contains two child elements");var o=e.find(".jira-dialog-core-content");equal(o.html(),"<div>Dialog content<div>AUI Dialog2 content</div></div>","Nested main content is pulled out and inserted to the root main content")}));test("should place content between footer and header if footer already exists",(function(){this.$content=t('<div>Dialog content<div class="aui-dialog2-content jira-dialog-core-content"><div>AUI Dialog2 content</div></div></div>');this.dialog=new i({content:this.$content});this.dialog.addFooterButtons(t("<button>Button 1</button>"));this.dialog.show();var e=this.dialog.$popup;equal(e.children().get(0),e.find(".aui-dialog2-header").get(0),"Header is the first child");equal(e.children().get(1),e.find(".jira-dialog-core-content").get(0),"Content is the second child");equal(e.children().get(2),e.find(".aui-dialog2-footer").get(0),"Footer is the third child")}));module("DialogFooter",{setup:function(){this.sandbox=sinon.sandbox.create()},teardown:function(){this.dialog.hide();this.$content.remove();this.sandbox.restore()}});test("should render footer and buttons if adding footer buttons and dialog has no footer",(function(){var e,o=[t("<button>Button 1</button>"),t("<button>Button 2</button>")];this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.dialog.show();var n=this.dialog.$popup;equal(n.children(".aui-dialog2-footer").length,0,"Dialog doesn't have footer");(e=this.dialog).addFooterButtons.apply(e,o);equal(n.children(".aui-dialog2-footer").length,1,"Dialog has footer");equal(n.find(".aui-dialog2-footer .buttons").children().get(0),o[0].get(0),"First button is added");equal(n.find(".aui-dialog2-footer .buttons").children().get(1),o[1].get(0),"Second button is added")}));test("should add cancel button",(function(){this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.dialog.show();var e=this.dialog.$popup,o=sinon.spy();this.dialog.addCancelButton(o);equal(e.find(".aui-dialog2-footer").children().length,1,"Footer has one button");equal(o.callCount,0,"Callback not called")}));test("should hide the dialog and call passed callback when clicking cancel button",(function(){this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.dialog.show();var e=this.dialog.$popup,o=sinon.spy();this.dialog.addCancelButton(o);e.find(".aui-dialog2-footer button").click();equal(o.callCount,1,"Callback called");equal(e.is(":visible"),!1,"Dialog hidden")}));test("should add primary button and call callback on click",(function(){this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.dialog.show();var e=this.dialog.$popup,o=sinon.spy();this.dialog.addMainActionButton({},o);equal(e.find(".aui-dialog2-footer").children().length,1,"Footer has one button");equal(o.callCount,0,"Callback not called");e.find(".aui-dialog2-footer button").click();equal(o.callCount,1,"Callback called")}));test("should add primary button with custom props",(function(){this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.auiButtonTemplateStub=this.sandbox.spy(aui.buttons,"button");this.dialog.show();var e=sinon.spy();this.dialog.addMainActionButton({extraClasses:["foo"],text:"Primary"},e);equal(this.auiButtonTemplateStub.calledOnce,!0,"AUI button template is called");equal(this.auiButtonTemplateStub.getCall(0).args[0].extraClasses[0],"foo","Button is called with extra class");equal(this.auiButtonTemplateStub.getCall(0).args[0].text,"Primary","Button has correct text")}));test("should add primary button with disabled state by default",(function(){this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.auiButtonTemplateStub=this.sandbox.spy(aui.buttons,"button");this.dialog.show();this.dialog.addMainActionButton({text:"Primary",defaultEnabled:!1});equal(this.auiButtonTemplateStub.calledOnce,!0,"AUI button template is called");equal(this.auiButtonTemplateStub.getCall(0).args[0].isDisabled,!0,"Button is disabled")}));test("should add primary button with default state",(function(){this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.auiButtonTemplateStub=this.sandbox.spy(aui.buttons,"button");this.dialog.show();this.dialog.addMainActionButton({},(function(){}));var e=this.auiButtonTemplateStub.getCall(0).args[0];equal(e.isDisabled,!1,"Button is enabled");equal(e.type,"primary","Button is primary");equal(e.text,"common.forms.confirm","Button has default text");equal(e.extraClasses.length,0,"Button has no extra classes")}));test("should disable controls of non-cancel buttons",(function(){this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.dialog.show();var e=this.dialog.$popup;this.dialog.addCancelButton();this.dialog.addFooterButtons(t("<button>Button 1</button>"),t("<button>Button 2</button>"));var o=e.find(".aui-dialog2-footer button.cancel"),n=e.find(".aui-dialog2-footer button:not(.cancel)");this.dialog.disableControls();equal(o.prop("disabled"),!1,"Cancel button is enabled");equal(n.get(0).disabled,!0,"First primary button is disabled");equal(n.get(1).disabled,!0,"Second primary button is disabled")}));test("should enable controls of non-cancel buttons",(function(){this.$content=t("<div>Dialog content</div>");this.dialog=new i({content:this.$content});this.dialog.show();var e=this.dialog.$popup;this.dialog.addCancelButton();this.dialog.addFooterButtons(t("<button>Button 1</button>"),t("<button>Button 2</button>"));var o=e.find(".aui-dialog2-footer button.cancel"),n=e.find(".aui-dialog2-footer button:not(.cancel)");n.prop("disabled",!0);this.dialog.enableControls();equal(o.prop("disabled"),!1,"Cancel button is enabled");equal(n.get(0).disabled,!1,"First primary button is enabled");equal(n.get(1).disabled,!1,"Second primary button is enabled")}));test("should add form attribute if dialog has form and submit button does not have the attribute",(function(){this.$content=t('<form id="dialog2-form">Dialog2 form<div class="aui-dialog2-footer"><button type="submit">Submit</button></div></form>');this.dialog=new i({content:this.$content});this.dialog.show();var e=this.dialog.$popup,o=e.find("form"),n=e.find(".aui-dialog2-footer button[type=submit]");equal(n.attr("form"),o.attr("id"),"Button has form attribute")}));test("should not add form attribute if dialog does not have form",(function(){this.$content=t('<div>Dialog2 content<div class="aui-dialog2-footer"><button type="submit">Submit</button></div></div>');this.dialog=new i({content:this.$content});this.dialog.show();var e=this.dialog.$popup.find("div button[type=submit]");equal(e.attr("form"),void 0,"Button does not have form attribute")}));module("DialogStack",{setup:function(){this.context=AJS.test.mockableModuleContext();this.DialogStack=this.context.require("jira/dialog/dialog-stack")}});test("[BC] Should support reading directly from `current` prop",(function(){o.current=null;strictEqual(i.current,null)}));test("[BC] Should support writing directly to `current` prop",(function(){var t={};o.current=null;i.current=t;strictEqual(i.current,t);strictEqual(o.current,t)}))}));