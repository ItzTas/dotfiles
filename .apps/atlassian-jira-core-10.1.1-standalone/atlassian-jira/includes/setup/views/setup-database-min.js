define("jira/setup/setup-database-view",["jira/ajs/select/single-select","wrm/context-path","jquery","jira/backbone-1.3.3","underscore","jira/setup/setup-abstract-view","jira/ajs/ajax/smart-ajax","jira/setup/setup-tracker","jira/setup/setup-language-view"],(function(e,i,t,s,a,n,o,l,r){return n.extend({languageDialogSelector:"#jira-setup-language-dialog",defaults:{mssql:{port:"1433",schema:"dbo"},mysql8:{port:"3306",schema:""},oracle10g:{port:"1521",schema:""},postgres72:{port:"5432",schema:"public"},postgresaurora96:{port:"5432",schema:"public"}},ui:{dbMessages:".db-message",dbOption:"input[name=databaseOption]",dbSpecificFields:".db-specific-field",dbType:"#jira-setup-database-field-database-type",errorMessages:".jira-setup-global-messages .aui-message-error",externalDbFields:".external-db-field",externalDbFieldsArea:"#setup-db-external",form:"#jira-setup-database",globalMessages:".jira-setup-global-messages",port:"#jira-setup-database-field-port",schema:"#jira-setup-database-field-schema",submit:"#jira-setup-database-submit",submitSpinner:".submit-spinner",successMessages:".jira-setup-global-messages .aui-message-success",testButton:"#jira-setup-database-test-connection",testConnectionSpinner:".test-connection-spinner",testingConnection:"#jira-setup-database-field-testing-connection",migrations:"#migrations",connectingJiraToDB:"#connecting-jira-to-db",languageDialogTrigger:".jira-setup-language-dialog-trigger"},events:{"change @ui.dbOption":"onDbOptionChangeWrapper","change @ui.dbType":"onDbTypeChange","click @ui.testButton":"onTestButtonPressed","submit @ui.form":"onSubmit","click @ui.migrations":"migrationsClicked","click @ui.connectingJiraToDB":"connectingJiraToDBClicked","click @ui.languageDialogTrigger":"onLanguageDialogTriggerClick"},templates:{externalDbFields:JIRA.Templates.Setup.Database.externalDbFields,globalMessages:JIRA.Templates.Setup.Database.globalMessages,unableToTestConnection:JIRA.Templates.Setup.Database.unableToTestConnection},_previouslyPrevented:!1,initialize:function(){l.insert();this.bindUIElements();this.initAUIFields();this.onDbTypeChange();this.langDialog=AJS.dialog2(this.languageDialogSelector);this.languageView=new r({el:this.languageDialogSelector});this.listenTo(this.languageView,"cancel-requested",this.onLanguageViewCancelRequested);this.langDialog.on("show",a.bind((function(){this.languageView.showInitial();this.languageView.start()}),this));var e=this.getPageDataKey("choiceBoxValue");e&&this.selectChoiceBox(e)},initAUIFields:function(){this.ui.dbType.hasClass("aui-ss-select")||new e({element:this.ui.dbType})},renderExternalDbFieldsArea:function(e){this.ui.externalDbFieldsArea.html(this.templates.externalDbFields(e));this.bindUIElements()},onDbTypeChange:function(){this.adjustExternalDbFields(!0)},adjustExternalDbFields:function(e){e=void 0===e||e;var i,t=(i=this.ui.dbType.val(),a.isArray(i)?i[0]:i);if(t){if(e){this.ui.port.val(this.defaults[t].port);this.ui.schema.val(this.defaults[t].schema)}var s=".db-type-"+t;this.ui.dbSpecificFields.addClass("hidden").filter(s).removeClass("hidden");this.ui.dbMessages.addClass("hidden").filter(s).removeClass("hidden")}else{this.ui.dbMessages.addClass("hidden");this.ui.dbSpecificFields.addClass("hidden")}},onSubmit:function(e){if(this._previouslyPrevented)return!0;e.preventDefault();this._previouslyPrevented=!0;l.sendUserPickedDatabase(this.ui.dbOption.val());setTimeout(a.bind((function(){this.ui.form.submit()}),this),0);this.disallowFormSubmit();this.cleanGlobalMessages();this.ui.submitSpinner.removeClass("hidden")},disallowFormSubmit:function(){this.ui.submit.prop("disabled",!0);this.ui.testButton.prop("disabled",!0)},allowFormSubmit:function(){this.ui.submit.prop("disabled",!1);this.ui.testButton.prop("disabled",!1)},cleanGlobalMessages:function(){this.ui.globalMessages.empty()},renderGlobalMessages:function(e){this.ui.globalMessages.html(this.templates.globalMessages(e));this.bindUIElements()},handleTestConnectionError:function(){this.ui.globalMessages.html(this.templates.unableToTestConnection());this.bindUIElements()},onTestButtonPressed:function(e){e.preventDefault();this.testConnection()},testConnection:function(){this.ui.testConnectionSpinner.removeClass("hidden");this.disallowFormSubmit();this.cleanGlobalMessages();o.makeRequest({cache:!1,data:this.ui.form.serialize(),dataType:"json",type:"GET",url:i()+"/secure/SetupDatabase!connectionCheck.jspa",success:a.bind((function(e){if(e&&e.data){this.renderExternalDbFieldsArea(e.data);this.renderGlobalMessages(e.data)}else this.handleTestConnectionError()}),this),error:a.bind((function(){this.handleTestConnectionError()}),this),complete:a.bind((function(){this.ui.testConnectionSpinner.addClass("hidden");this.adjustExternalDbFields(!1);this.allowFormSubmit();this.initAUIFields()}),this)})},migrationsClicked:function(){l.sendUserClickedOnMigrationsLink()},connectingJiraToDBClicked:function(){l.sendUserClickedOnConnectingJiraToDatabaseLink()},onLanguageDialogTriggerClick:function(){this.openLanguageDialog()},openLanguageDialog:function(){this.langDialog&&this.langDialog.show()},onLanguageViewCancelRequested:function(){this.langDialog.hide()},onChoiceBoxValueChange:function(e){n.prototype.onChoiceBoxValueChange.apply(this,arguments);this.ui.submitButton.attr("value",e.data("choice-submit"))}})}));