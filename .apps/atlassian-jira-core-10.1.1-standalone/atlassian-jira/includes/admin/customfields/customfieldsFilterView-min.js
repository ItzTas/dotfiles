define("jira/customfields/customfieldsFilterView",["atlassian/libs/underscore-1.8.3","jira/marionette-4.1","jira/analytics","jira/featureflags/feature-manager","jira/util/formatter","jira/customfields/customfieldsFilterDropdownView","jira/customfields/customfieldsSelectDropdownView","jira/customfields/customfieldsFilterProjectCollection","jira/customfields/customfieldsFilterTypesCollection","jira/customfields/customfieldsFilterScreensCollection","jira/customfields/customfieldsSelectLastValueUpdateCollection"],(function(e,t,i,s,o,r,n,l,c,a,d){"use strict";var p=s.isFeatureEnabled("jira.customfields.cleanup.identification");return t.View.extend({template:JIRA.Templates.Admin.Customfields.filterContainer,templateContext:{showLastValueUpdateFilter:p},ui:{searchInput:"#custom-fields-filter-text",projectsTrigger:"#projects-dropdown-trigger",typesTrigger:"#types-dropdown-trigger",screensTrigger:"#screens-dropdown-trigger",lastValueUpdateTrigger:"#last-value-update-dropdown-trigger",projectsDropdown:"#projects-filter-dropdown",typesDropdown:"#types-filter-dropdown",screensDropdown:"#screens-filter-dropdown",lastValueUpdateDropdown:"#last-value-update-filter-dropdown",container:".customfield-filter-items"},regions:function(){var e={screens:{el:"#screens-filter-dropdown",replaceElement:!0},types:{el:"#types-filter-dropdown",replaceElement:!0},projects:{el:"#projects-filter-dropdown",replaceElement:!0}};p&&(e.lastValueUpdate={el:"#last-value-update-filter-dropdown",replaceElement:!0});return e},events:{"input @ui.searchInput":"performTextSearch","aui-dropdown2-show @ui.projectsDropdown":function(){this.projectsDropdownView.reorderItems();this.projectsDropdownView.focusField()},"aui-dropdown2-show @ui.typesDropdown":function(){this.typesDropdownView.reorderItems();this.typesDropdownView.focusField()},"aui-dropdown2-show @ui.screensDropdown":function(){this.screensDropdownView.reorderItems();this.screensDropdownView.focusField()}},childViewEvents:{"filter:changed":"onChildviewFilterChanged","filter:cleared":"onChildviewFilterCleared","option:selected":"onChildviewOptionSelected"},initialize:function(){this.projectFilterCollection=new l;this.typesFilterCollection=new c;this.screensFilterCollection=new a;this.lastValueUpdateCollection=new d;this.projectsDropdownView=new r({collection:this.projectFilterCollection,id:"projects-filter-dropdown",customfieldCollection:this.collection});this.typesDropdownView=new r({collection:this.typesFilterCollection,id:"types-filter-dropdown",customfieldCollection:this.collection});this.screensDropdownView=new r({collection:this.screensFilterCollection,id:"screens-filter-dropdown",customfieldCollection:this.collection});p&&(this.lastValueUpdateDropdownView=new n({collection:this.lastValueUpdateCollection,id:"last-value-update-filter-dropdown"}))},onRender:function(){this.unwrapTemplate();this.showChildView("projects",this.projectsDropdownView);this.showChildView("types",this.typesDropdownView);this.showChildView("screens",this.screensDropdownView);p&&this.showChildView("lastValueUpdate",this.lastValueUpdateDropdownView);this.setButtonsText(this.projectFilterCollection);this.setButtonsText(this.screensFilterCollection);this.setButtonsText(this.typesFilterCollection);p&&this.setButtonsText(this.lastValueUpdateCollection,!0)},onChildviewFilterChanged:function(t){var i=t.model.collection,s=i.id,o=t.getUI("filter"),r=o.val(),n=o.prop("checked"),l=this.collection.filters[s];n&&!e.contains(l,r)?l.push(r):!n&&e.contains(l,r)&&l.splice(l.indexOf(r),1);this.sendAnalyticsFilterEvent(s,l);this.setButtonsText(i);this.performSearch()},onChildviewOptionSelected:function(e){var t=e.model.collection.id;this.collection.filters[t]=e.model.get("value");this.sendAnalyticsFilterEvent(t,[e.model.get("value")]);this.setButtonsText(e.model.collection,!0);this.performSearch()},onChildviewFilterCleared:function(e){this.setButtonsText(e);this.performSearch()},performSearch:function(){var e=this;this.triggerMethod("search:start");this.collection.getFirstPage({reset:!0}).always((function(){e.triggerMethod("search:end")})).fail((function(t){return e.triggerMethod("navigate:error",t)}))},performTextSearch:e.debounce((function(){var e=this,t=this.getUI("searchInput"),i=t.val();if(i!==this.currentInputValue){this.triggerMethod("search:start");t.blur();this.currentInputValue=i;this.collection.searchTerm=i;this.collection.getFirstPage({reset:!0}).always((function(){t.focus();e.triggerMethod("search:end")})).fail((function(t){return e.triggerMethod("navigate:error",t)}))}}),500),currentInputValue:"",sendAnalyticsFilterEvent:function(e,t){var s=e;switch(e){case"projectIds":s="projects";break;case"types":s="types";break;case"screenIds":s="screens";break;case"lastValueUpdate":s="lastvalueupdate"}i.send({name:"admin.customfields.filter.".concat(s),properties:{values:t||[]}})},setButtonsText:function(e,t){var i=e.id,s=e.name,o=this.getUI("".concat(s,"Trigger")),r=this.collection.filters[i]||[];if(!r||Array.isArray(r)&&0===r.length)return o.text(this._getDefaultButtonText(s));var n=t?"".concat(this._getFilterTitle(s),": "):"";return o.text(n+this._getAppliedFilterNames(s,r))},_getFilterTitle:function(e){var t;switch(e){case"projects":t=o.I18n.getText("common.words.project");break;case"screens":t=o.I18n.getText("admin.common.words.screen");break;case"types":t=o.I18n.getText("admin.common.words.type");break;case"lastValueUpdate":t=o.I18n.getText("admin.issuefields.last.value.update")}return t},_getDefaultButtonText:function(e){var t=this._getFilterTitle(e);return"".concat(t,": ").concat(o.I18n.getText("common.words.all"))},_getAppliedFilterNames:function(t,i){var s;switch(t){case"projects":s=this.projectFilterCollection;break;case"screens":s=this.screensFilterCollection;break;case"types":s=this.typesFilterCollection;break;case"lastValueUpdate":s=this.lastValueUpdateCollection}return Array.isArray(i)?s.reduce((function(t,s){e.contains(i,s.id.toString())&&s.get("name").length>0&&t.push(s.get("name"));return t}),[]).join(", "):s.find({value:i}).get("name")}})}));