const MILLENNIUM_IS_CLIENT_MODULE=!0,pluginName="steam-librarian";function InitializePlugins(){var e,t;let a;(e=window.PLUGIN_LIST||(window.PLUGIN_LIST={}))[pluginName]||(e[pluginName]={}),(t=window.MILLENNIUM_PLUGIN_SETTINGS_STORE||(window.MILLENNIUM_PLUGIN_SETTINGS_STORE={}))[pluginName]||(t[pluginName]={}),window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS||(window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS={}),function(e){e[e.CallServerMethod=0]="CallServerMethod"}(a||(a={}));let n=window.MILLENNIUM_PLUGIN_SETTINGS_STORE[pluginName],i=`Millennium.Internal.IPC.[${pluginName}]`;const o={DropDown:["string","number","boolean"],NumberTextInput:["number"],StringTextInput:["string"],FloatTextInput:["number"],CheckBox:["boolean"],NumberSlider:["number"],FloatSlider:["number"]};function r(e,t,n){return MILLENNIUM_BACKEND_IPC.postMessage(a.CallServerMethod,{pluginName:e,methodName:"__builtins__.__update_settings_value__",argumentList:{name:t,value:n}})}n.ignoreProxyFlag=!1,async function(){for(;"undefined"==typeof MainWindowBrowserManager;)await new Promise(e=>setTimeout(e,0));MainWindowBrowserManager?.m_browser?.on("message",(e,t)=>{if(e!==i)return;const{name:a,value:o}=JSON.parse(t);n.ignoreProxyFlag=!0,n.settingsStore[a]=o,r(pluginName,a,o),n.ignoreProxyFlag=!1})}();const l=e=>new Proxy(e,{set(e,t,a){if(!(t in e))throw new TypeError(`Property ${String(t)} does not exist on plugin settings`);const l=o[e[t].type],s=e[t]?.range;if(l.includes("number")&&"number"==typeof a&&(s&&(a=function(e,t,a){return Math.max(t,Math.min(a,e))}(a,s[0],s[1])),a||(a=0)),!l.includes(typeof a))throw new TypeError(`Expected ${l.join(" or ")}, got ${typeof a}`);return e[t].value=a,((e,t)=>{n.ignoreProxyFlag||(r(pluginName,e,t),"undefined"!=typeof MainWindowBrowserManager&&MainWindowBrowserManager?.m_browser?.PostMessage(i,JSON.stringify({name:e,value:t})))})(String(t),a),!0},get:(e,t)=>"__raw_get_internals__"===t?e:t in e?e[t].value:void 0});n.DefinePluginSetting=l,n.settingsStore=l({})}InitializePlugins();const __call_server_method__=(e,t)=>Millennium.callServerMethod(pluginName,e,t),__wrapped_callable__=e=>MILLENNIUM_API.callable(__call_server_method__,e);let PluginEntryPointMain=function(){return function(e,t,a){"use strict";const n=__wrapped_callable__("Backend.get_autoselect_item"),i=__wrapped_callable__("Backend.get_open_details"),o=__wrapped_callable__("Backend.get_library_size"),r=__wrapped_callable__("Backend.get_millennium_systray"),l=__wrapped_callable__("Backend.get_systray_text"),s=__wrapped_callable__("Backend.get_remove_news"),p=__wrapped_callable__("Backend.get_remove_review_ask"),_=__wrapped_callable__("Backend.get_extra_options_count"),d=__wrapped_callable__("Backend.get_mark_shortcuts_offline"),c=__wrapped_callable__("Backend.get_check_shortcuts_exist"),u=__wrapped_callable__("Backend.fs_file_exists"),m=__wrapped_callable__("Backend.get_restart_menu"),g=__wrapped_callable__("Backend.get_extra_option"),w=__wrapped_callable__("Backend.get_restart_text"),f=__wrapped_callable__("Backend.run_extra_option"),S=__wrapped_callable__("Backend.get_scroll_to_app"),M=__wrapped_callable__("Backend.get_app_downgrader"),b=__wrapped_callable__("Backend.copy_files"),I=async(e,a=document)=>[...await t.Millennium.findElement(a,e)][0],N=async(e,a=document,n=1e3)=>[...await t.Millennium.findElement(a,e,n)][0],h=async(e,a=document)=>[...await t.Millennium.findElement(a,e)];var y=void 0,v=void 0;async function C(e){if("SP Desktop_uid0"===e.m_strName)MainWindowBrowserManager.m_browser.on("finished-request",async(a,r)=>{if("/library/home"===MainWindowBrowserManager.m_lastLocation.pathname){const a=await n({});if(""!==a){const e=appStore.allApps.find(e=>e.display_name===a);SteamUIStore.Navigate(`/library/app/${e.appid}`)}const i=await o({});if(""!==i&&((await I("div.LibraryDisplaySizeSmall, div.LibraryDisplaySizeMedium, div.LibraryDisplaySizeLarge",e.m_popup.document)).firstChild.style=`width: ${i}; min-width: 1px !important;`),await s({}))try{const a=await N(`div.${t.findModule(e=>e.UpdatesContainer).UpdatesContainer}`,e.m_popup.document);a&&a.remove()}catch{}const r=await d({}),l=await c({});if(r)for(const e of appStore.allApps)e.BIsShortcut()&&(e.per_client_data[0].installed=!1);else if(l)for(const e of appStore.allApps)if(e.BIsShortcut()){await appDetailsStore.RequestAppDetails(e.appid);const t=appDetailsStore.GetAppDetails(e.appid).strShortcutExe;await u({file_path:t})||(e.per_client_data[0].installed=!1)}}else if(MainWindowBrowserManager.m_lastLocation.pathname.startsWith("/library/app/")){if(await i({}))try{await N(`div.${t.findModule(e=>e.AppDetailsCollapsed).AppDetailsCollapsed}`,e.m_popup.document)&&(await I(`div.${t.findModule(e=>e.InPage).InPage} div.${t.findModule(e=>e.AppButtonsContainer).AppButtonsContainer} svg.SVGIcon_Information`,e.m_popup.document)).parentElement.click()}catch{}const a=await _({}),n=await S({});if(a>0||n){const i=await I(`div.${t.findModule(e=>e.InPage).InPage} div.${t.findModule(e=>e.AppButtonsContainer).AppButtonsContainer} > div.${t.findModule(e=>e.MenuButtonContainer).MenuButtonContainer}:not([role="button"])`,e.m_popup.document);if(!i.parentNode.querySelector("div.extra-settings-button")){const e=i.cloneNode(!0);e.classList.add("extra-settings-button"),e.firstChild.innerHTML="+",i.parentNode.insertBefore(e,i.nextSibling),e.addEventListener("click",async()=>{const i=[];if(n){const e=uiStore.currentGameListSelection.strCollectionId,a=uiStore.currentGameListSelection.nAppId;i.push(window.SP_REACT.createElement(t.MenuItem,{onClick:async()=>{y=e,v=a,console.log("[steam-librarian] Switch to:",e),SteamUIStore.Navigate(`/library/collection/${e}`)}}," Scroll to App "))}for(let e=0;e<a;e++){const a=await g({opt_num:e}),n=collectionStore.GetCollection(uiStore.currentGameListSelection.strCollectionId).allApps.find(e=>e.appid===uiStore.currentGameListSelection.nAppId);i.push(window.SP_REACT.createElement(t.MenuItem,{onClick:async()=>{await f({opt_num:e,app_id:uiStore.currentGameListSelection.nAppId,app_name:n.display_name})}}," ",a," "))}t.showContextMenu(window.SP_REACT.createElement(t.Menu,{label:"Extra Options"},i),e,{bForcePopup:!0})})}}if(await p({}))try{const a=await N(`div.${t.findModule(e=>e.ReviewContainer).ReviewContainer}`,e.m_popup.document);if(a){const e=a.parentElement;a.remove(),0===e.children.length&&e.remove()}}catch{}const o=await d({}),r=await c({});if(o){const e=appStore.allApps.find(e=>e.appid===uiStore.currentGameListSelection.nAppId);e.BIsShortcut()&&(e.per_client_data[0].installed=!1)}else if(r){const e=appStore.allApps.find(e=>e.appid===uiStore.currentGameListSelection.nAppId);if(e.BIsShortcut()){await appDetailsStore.RequestAppDetails(e.appid);const t=appDetailsStore.GetAppDetails(e.appid).strShortcutExe;await u({file_path:t})||(e.per_client_data[0].installed=!1)}}}else if(MainWindowBrowserManager.m_lastLocation.pathname.startsWith("/library/collection/")&&y&&MainWindowBrowserManager.m_lastLocation.pathname===`/library/collection/${y}`){console.log("[steam-librarian] Switched to wanted collection:",y);const a=await I(`div.${t.findModule(e=>e.CSSGrid).CSSGrid}[role='grid']`,e.m_popup.document);for(;;){let e=a.querySelector(`img[src^='/assets/${v}/'`);if(e){console.log("[steam-librarian] Wanted app image found, scrolling..."),e.scrollIntoView({block:"center"}),y=void 0,v=void 0;break}console.log("[steam-librarian] App image not found, scrolling to current bottom..."),a.children[a.children.length-1].querySelector("img").scrollIntoView({block:"end"}),await t.sleep(100)}}});else if("Menu"===e.m_strTitle){if(await r({})){const a=await h(`div#popup_target div.contextMenuItem > div.${t.findModule(e=>e.JumpListItemText).JumpListItemText}`,e.m_popup.document),n=a[a.length-1].parentNode,i=n.cloneNode(!0),o=await l({transmit_encoded:!0});i.firstChild.textContent=decodeURIComponent(escape(window.atob(o))),n.parentNode.insertBefore(i,n.previousSibling),i.addEventListener("click",async()=>{SteamUIStore.Navigate("/millennium/settings")})}}else if("Steam Root Menu"===e.m_strTitle){if(await m({})){console.log("[steam-librarian] Steam Root Menu reached!");const t=await h("div#popup_target div[role='menuitem']",e.m_popup.document),a=t[t.length-1],n=a.cloneNode(!0),i=await w({transmit_encoded:!0});n.textContent=decodeURIComponent(escape(window.atob(i))),a.parentNode.insertBefore(n,a),n.addEventListener("click",async()=>{SteamClient.User.StartRestart(!0)})}}else if(e.m_strName.startsWith("PopupWindow_")&&await M({}))try{const n=await N("div.DialogContent[id$='/properties/general_Content']",e.m_popup.document);if(n){const i=n.id.substring(n.id.indexOf("/app/")+5,n.id.indexOf("/properties/general_Content"));console.log("[steam-librarian] Detected App General Properties window for:",i),new MutationObserver(async(o,r)=>{if(n.id.endsWith("/properties/updates_Content")){const o=e.m_popup.document.createElement("div");a.createRoot(o).render(window.SP_REACT.createElement(t.DialogButton,{style:{width:"100%"}},"Custom Up/Downgrade")),(await I("div.DialogBody",n)).appendChild(o),o.firstChild.addEventListener("click",async()=>{console.log("[steam-librarian] Custom Up/Downgrade button clicked!"),MainWindowBrowserManager.ShowURL(`https://steamdb.info/app/${i}/depots/#depots`),o.firstChild.textContent="Waiting for Manifest...",o.firstChild.disabled=!0;const a=new RegExp("https://steamdb\\.info/depot/(\\d+)/history/\\?changeid=M:(.+)");for(;e.m_popup&&!a.test(MainWindowBrowserManager.m_URL);)await t.sleep(300);if(!e.m_popup)return;const n=a.exec(MainWindowBrowserManager.m_URL),r=n[1],l=n[2];console.log(`[steam-librarian] App: ${i}; Depot: ${r}; Manifest:`,l),await SteamClient.Apps.SetAppAutoUpdateBehavior(parseInt(i),1),console.log("[steam-librarian] App update behaviour set to 'Launch'"),o.firstChild.textContent="Downloading Depot...";const s=`download_depot ${i} ${r} ${l}`,p=new RegExp(`Depot download complete *: *"(.+)" \\(manifest ${l}\\)`),_=await async function(e,t){return new Promise(a=>{const n=SteamClient.Console.RegisterForSpewOutput(e=>{console.log("[Steam Console]",e.spew),t.test(e.spew)&&(console.log("[steam-librarian] Found desired output!"),n.unregister(),a(e.spew))});console.log("[steam-librarian] Executing",e),SteamClient.Console.ExecCommand(e)})}(s,p);if(!e.m_popup)return;const d=p.exec(_)[1];console.log("[steam-librarian] Download path:",d),o.firstChild.textContent="Updating app...",await appDetailsStore.RequestAppDetails(parseInt(i));const c=appDetailsStore.GetAppDetails(parseInt(i)).strInstallFolder;await b({source_dir:d,destination_dir:c}),o.firstChild.textContent="Done!"})}}).observe(n,{attributes:!0,attributeFilter:["id"]})}}catch{}}return e.default=async function(){for(console.log("[steam-librarian] frontend startup"),await App.WaitForServicesInitialized();"undefined"==typeof g_PopupManager||"undefined"==typeof MainWindowBrowserManager;)await t.sleep(100);for(var e=void 0;!e;){console.log("[steam-librarian] Waiting for MainWindowBrowserManager");try{e=MainWindowBrowserManager}catch{await t.sleep(100)}}const a=await n({});console.log("[steam-librarian] Result from get_autoselect_item:",a);const l=await i({});console.log("[steam-librarian] Result from get_open_details:",l);const g=await o({});console.log("[steam-librarian] Result from get_library_size:",g);const w=await r({});console.log("[steam-librarian] Result from get_millennium_systray:",w);const f=await s({});console.log("[steam-librarian] Result from get_remove_news:",f);const b=await p({});console.log("[steam-librarian] Result from get_remove_review_ask:",b);const I=await _({});console.log("[steam-librarian] Result from get_extra_options_count:",I);const N=await d({});console.log("[steam-librarian] Result from get_mark_shortcuts_offline:",N);const h=await c({});console.log("[steam-librarian] Result from get_check_shortcuts_exist:",h);const y=await m({});console.log("[steam-librarian] Result from get_restart_menu:",y);const v=await S({});console.log("[steam-librarian] Result from get_scroll_to_app:",v);const E=await M({});console.log("[steam-librarian] Result from get_app_downgrader:",E);const L=g_PopupManager.GetExistingPopup("SP Desktop_uid0");if(L&&C(L),g_PopupManager.m_mapPopups.data_.forEach(e=>{"Menu"!==e.value_.m_strTitle&&"Steam Root Menu"!==e.value_.m_strTitle||C(e.value_)}),g_PopupManager.AddPopupCreatedCallback(C),N)for(const e of appStore.allApps)e.BIsShortcut()&&(e.per_client_data[0].installed=!1);else if(h)for(const e of appStore.allApps)if(e.BIsShortcut()){await appDetailsStore.RequestAppDetails(e.appid);const t=appDetailsStore.GetAppDetails(e.appid).strShortcutExe;await u({file_path:t})||(e.per_client_data[0].installed=!1)}},Object.defineProperty(e,"__esModule",{value:!0}),e}({},window.MILLENNIUM_API,window.SP_REACTDOM)};function ExecutePluginModule(){let e=window.MILLENNIUM_PLUGIN_SETTINGS_STORE[pluginName];e.OnPluginConfigChange=function(t,a,n){t in e.settingsStore&&(e.ignoreProxyFlag=!0,e.settingsStore[t]=n,e.ignoreProxyFlag=!1)},MILLENNIUM_BACKEND_IPC.postMessage(0,{pluginName:pluginName,methodName:"__builtins__.__millennium_plugin_settings_parser__"}).then(async t=>{"string"==typeof t.returnValue&&(e.ignoreProxyFlag=!0,e.settingsStore=e.DefinePluginSetting(Object.fromEntries(JSON.parse(atob(t.returnValue)).map(e=>[e.functionName,e]))),e.ignoreProxyFlag=!1);let a=PluginEntryPointMain();Object.assign(window.PLUGIN_LIST[pluginName],{...a,__millennium_internal_plugin_name_do_not_use_or_change__:pluginName});let n=await a.default();var i;n&&(i=n)&&void 0!==i.title&&void 0!==i.icon&&void 0!==i.content?(window.MILLENNIUM_SIDEBAR_NAVIGATION_PANELS[pluginName]=n,MILLENNIUM_BACKEND_IPC.postMessage(1,{pluginName:pluginName})):console.warn(`Plugin ${pluginName} does not contain proper SidebarNavigation props and therefor can't be mounted by Millennium. Please ensure it has a title, icon, and content.`)})}ExecutePluginModule();