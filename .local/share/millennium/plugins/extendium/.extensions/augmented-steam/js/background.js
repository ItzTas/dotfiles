"use strict";var _as=(()=>{var At=Object.create;var ve=Object.defineProperty;var kt=Object.getOwnPropertyDescriptor;var Pt=Object.getOwnPropertyNames;var Tt=Object.getPrototypeOf,It=Object.prototype.hasOwnProperty;var Ct=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Dt=(r,e)=>{for(var t in e)ve(r,t,{get:e[t],enumerable:!0})},Je=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Pt(e))!It.call(r,s)&&s!==t&&ve(r,s,{get:()=>e[s],enumerable:!(o=kt(e,s))||o.enumerable});return r};var L=(r,e,t)=>(t=r!=null?At(Tt(r)):{},Je(e||!r||!r.__esModule?ve(t,"default",{value:r,enumerable:!0}):t,r)),Nt=r=>Je(ve({},"__esModule",{value:!0}),r);var E=Ct((Ne,at)=>{(function(r,e){if(typeof define=="function"&&define.amd)define("webextension-polyfill",["module"],e);else if(typeof Ne<"u")e(at);else{var t={exports:{}};e(t),r.browser=t.exports}})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:Ne,function(r){"use strict";if(!chrome?.runtime?.id)throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){let e="The message port closed before a response was received.",t=o=>{let s={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(s).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class n extends WeakMap{constructor(u,g=void 0){super(g),this.createItem=u}get(u){return this.has(u)||this.set(u,this.createItem(u)),super.get(u)}}let i=l=>l&&typeof l=="object"&&typeof l.then=="function",a=(l,u)=>(...g)=>{o.runtime.lastError?l.reject(new Error(o.runtime.lastError.message)):u.singleCallbackArg||g.length<=1&&u.singleCallbackArg!==!1?l.resolve(g[0]):l.resolve(g)},p=l=>l==1?"argument":"arguments",_=(l,u)=>function(x,...T){if(T.length<u.minArgs)throw new Error(`Expected at least ${u.minArgs} ${p(u.minArgs)} for ${l}(), got ${T.length}`);if(T.length>u.maxArgs)throw new Error(`Expected at most ${u.maxArgs} ${p(u.maxArgs)} for ${l}(), got ${T.length}`);return new Promise((I,N)=>{if(u.fallbackToNoCallback)try{x[l](...T,a({resolve:I,reject:N},u))}catch(m){console.warn(`${l} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,m),x[l](...T),u.fallbackToNoCallback=!1,u.noCallback=!0,I()}else u.noCallback?(x[l](...T),I()):x[l](...T,a({resolve:I,reject:N},u))})},f=(l,u,g)=>new Proxy(u,{apply(x,T,I){return g.call(T,l,...I)}}),k=Function.call.bind(Object.prototype.hasOwnProperty),P=(l,u={},g={})=>{let x=Object.create(null),T={has(N,m){return m in l||m in x},get(N,m,R){if(m in x)return x[m];if(!(m in l))return;let v=l[m];if(typeof v=="function")if(typeof u[m]=="function")v=f(l,l[m],u[m]);else if(k(g,m)){let $=_(m,g[m]);v=f(l,l[m],$)}else v=v.bind(l);else if(typeof v=="object"&&v!==null&&(k(u,m)||k(g,m)))v=P(v,u[m],g[m]);else if(k(g,"*"))v=P(v,u[m],g["*"]);else return Object.defineProperty(x,m,{configurable:!0,enumerable:!0,get(){return l[m]},set($){l[m]=$}}),v;return x[m]=v,v},set(N,m,R,v){return m in x?x[m]=R:l[m]=R,!0},defineProperty(N,m,R){return Reflect.defineProperty(x,m,R)},deleteProperty(N,m){return Reflect.deleteProperty(x,m)}},I=Object.create(l);return new Proxy(I,T)},M=l=>({addListener(u,g,...x){u.addListener(l.get(g),...x)},hasListener(u,g){return u.hasListener(l.get(g))},removeListener(u,g){u.removeListener(l.get(g))}}),Ie=new n(l=>typeof l!="function"?l:function(g){let x=P(g,{},{getContent:{minArgs:0,maxArgs:0}});l(x)}),Se=new n(l=>typeof l!="function"?l:function(g,x,T){let I=!1,N,m=new Promise(te=>{N=function(B){I=!0,te(B)}}),R;try{R=l(g,x,N)}catch(te){R=Promise.reject(te)}let v=R!==!0&&i(R);if(R!==!0&&!v&&!I)return!1;let $=te=>{te.then(B=>{T(B)},B=>{let De;B&&(B instanceof Error||typeof B.message=="string")?De=B.message:De="An unexpected error occurred",T({__mozWebExtensionPolyfillReject__:!0,message:De})}).catch(B=>{console.error("Failed to send onMessage rejected reply",B)})};return $(v?R:m),!0}),St=({reject:l,resolve:u},g)=>{o.runtime.lastError?o.runtime.lastError.message===e?u():l(new Error(o.runtime.lastError.message)):g&&g.__mozWebExtensionPolyfillReject__?l(new Error(g.message)):u(g)},$e=(l,u,g,...x)=>{if(x.length<u.minArgs)throw new Error(`Expected at least ${u.minArgs} ${p(u.minArgs)} for ${l}(), got ${x.length}`);if(x.length>u.maxArgs)throw new Error(`Expected at most ${u.maxArgs} ${p(u.maxArgs)} for ${l}(), got ${x.length}`);return new Promise((T,I)=>{let N=St.bind(null,{resolve:T,reject:I});x.push(N),g.sendMessage(...x)})},vt={devtools:{network:{onRequestFinished:M(Ie)}},runtime:{onMessage:M(Se),onMessageExternal:M(Se),sendMessage:$e.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:$e.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},Ce={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return s.privacy={network:{"*":Ce},services:{"*":Ce},websites:{"*":Ce}},P(o,vt,s)};r.exports=t(chrome)}else r.exports=globalThis.browser})});var Yt={};Dt(Yt,{Unrecognized:()=>b});var Ye="options_contextSteamStore",Ze="options_contextSteamLucky",Qe="options_contextSteamMarket",Xe="options_contextItad",et="options_contextBartervg",tt="options_contextSteamdb",ot="options_contextSteamdbInstant",st="options_contextSteamKeys";var rt="userNote_syncErrorEmpty",nt="userNote_syncErrorUnknown",it="userNote_syncErrorLength";var ct=L(E()),J={version:ct.default.runtime.getManifest().version,db_version:6};var Re=L(E());var eo=L(E()),j=class{constructor(e){this.storageArea=e}get onChanged(){return this.storageArea.onChanged}async get(e){return(await this.storageArea.get(e))[e]??void 0}getObject(e){return this.storageArea.get(e)}set(e,t){return this.storageArea.set({[e]:t})}setObject(e){return this.storageArea.set(e)}remove(...e){return this.storageArea.remove(e)}};var q=class extends j{constructor(){super(Re.default.storage.sync)}get QUOTA_BYTES_PER_ITEM(){return Re.default.storage.sync.QUOTA_BYTES_PER_ITEM??8192}},F=new q;var Ae={language:"english",version:J.version,version_show:!0,highlight_owned_color:"#00ce67",highlight_wishlist_color:"#0491bf",highlight_followed_color:"#d64550",highlight_coupon_color:"#a26426",highlight_inv_gift_color:"#800040",highlight_inv_guestpass_color:"#513c73",highlight_notinterested_color:"#4f4f4f",highlight_ignored_owned_color:"#4f4f4f",highlight_collection_color:"#856d0e",highlight_waitlist_color:"#4c7521",tag_owned_color:"#00b75b",tag_wishlist_color:"#0383b4",tag_followed_color:"#d64550",tag_coupon_color:"#c27120",tag_inv_gift_color:"#b10059",tag_inv_guestpass_color:"#65449a",tag_notinterested_color:"#4f4f4f",tag_ignored_owned_color:"#4f4f4f",tag_collection_color:"#856d0e",tag_waitlist_color:"#4c7521",highlight_owned:!0,highlight_wishlist:!0,highlight_followed:!0,highlight_coupon:!1,highlight_inv_gift:!1,highlight_inv_guestpass:!1,highlight_notinterested:!1,highlight_ignored_owned:!1,highlight_excludef2p:!1,highlight_collection:!0,highlight_waitlist:!0,tag_owned:!1,tag_wishlist:!1,tag_followed:!1,tag_coupon:!1,tag_inv_gift:!1,tag_inv_guestpass:!1,tag_notinterested:!0,tag_ignored_owned:!0,tag_collection:!1,tag_waitlist:!1,tag_short:!1,hidetmsymbols:!1,showlowestprice:!0,showlowestprice_onwishlist:!0,showlowestpricecoupon:!0,showallstores:!0,excluded_stores:[],override_price:"auto",showregionalprice:"mouse",regional_countries:["us","gb","fr","br","au","jp"],show_es_homepagetabs:!0,showmarkettotal:!1,showmcus:!0,showoc:!0,showhltb:!0,showyoutube:!0,showtwitch:!0,showpcgw:!0,showcompletionistme:!1,showprotondb:!1,showviewinlibrary:!1,showsteamcardexchange:!1,showitadlinks:!0,showsteamdb:!0,showbartervg:!1,showyoutubegameplay:!0,showyoutubereviews:!0,showwsgf:!0,exfgls:!0,app_custom_link:[{enabled:!0,name:"Google",url:"https://www.google.com/search?q=[ID]+[NAME]",icon:"https://www.google.com/images/branding/product/ico/googleg_lodp.ico"}],customize_apppage:{},customize_frontpage:{},show_package_info:!1,show_players_info:!0,show_early_access:!0,show_alternative_linux_icon:!1,show_itad_button:!1,skip_got_steam:!1,installsteam:"show",openinnewtab:!1,keepssachecked:!1,showemptywishlist:!0,user_notes_app:!0,user_notes_wishlist:!0,user_notes_simple:!0,showwishliststats:!0,oneclickremovewl:!1,user_notes_adapter:"synced_storage",showlanguagewarning:!0,showlanguagewarninglanguage:"english",homepage_tab_selection:"remember",send_age_info:!0,removebroadcasts:!1,prevent_video_pause:!1,tabtitle_appname_first:!1,horizontalscrolling:!0,showsupportinfo:!0,showdrm:!0,regional_hideworld:!1,showinvnav:!0,quickinv:!0,quickinv_diff:-.01,community_default_tab:"",showallstats:!0,replacecommunityhublinks:!1,hideannouncementcomments:!1,showachinstore:!0,hideactivelistings:!1,showlowestmarketprice:!0,hidespamcomments:!1,spamcommentregex:"[\\u2500-\\u25FF]",wlbuttoncommunityapp:!0,removeguideslanguagefilter:!1,confirmdeletecomment:!0,disablelinkfilter:!1,show1clickgoo:!0,show_profile_link_images:"gray",show_custom_themes:!0,profile_pinned_bg:!1,friends_append_nickname:!1,profile_steamrepcn:!0,profile_steamgifts:!0,profile_steamtrades:!0,profile_bartervg:!0,profile_steamdbcalc:!0,profile_backpacktf:!0,profile_steamid:!0,profile_custom_link:[{enabled:!0,name:"Google",url:"https://www.google.com/search?q=[ID]",icon:"https://www.google.com/images/branding/product/ico/googleg_lodp.ico"}],group_steamgifts:!0,steamcardexchange:!0,purchase_dates:!0,show_badge_progress:!0,show_coupon:!0,show_wishlist_link:!0,show_wishlist_count:!0,show_progressbar:!0,show_backtotop:!1,profile_showcase_twitch:!0,profile_showcase_own_twitch:!1,profile_showcase_twitch_profileonly:!1,itad_sync_library:!0,itad_sync_wishlist:!0,add_to_waitlist:!1,collection_banner_notowned:!1,itad_sync_notes:!1,context_steam_store:!1,context_steam_lucky:!1,context_steam_market:!1,context_itad:!1,context_bartervg:!1,context_steamdb:!1,context_steamdb_instant:!1,context_steam_keys:!1},ke=class{constructor(){this.listeners=new Set}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}invoke(){for(let e of this.listeners)e()}},w=class{static{this.storage=new q}static{this.onSaveStart=new ke}static{this.onSaveEnd=new ke}static async load(){this.data=await this.storage.getObject(Ae)}static init(){return this.promise||(this.promise=this.load()),this.promise}static getDefault(e){return Ae[e]}static get(e){if(!this.data)throw new Error("Settings have not been loaded");return this.data[e]}static async set(e,t){this.onSaveStart.invoke(),this.data[e]=t,await this.storage.set(e,t),this.onSaveEnd.invoke()}static remove(e){this.storage.remove(e),this.data[e]=structuredClone(Ae[e])}static clear(){this.storage.remove(...Object.keys(this.data)),this.data=structuredClone(Ae)}static async import(e){await this.storage.setObject(e),await this.load()}static asObject(){return structuredClone(this.data)}},y=new Proxy(w,{get(r,e){return r.get(e)},set(r,e,t){return r.set(e,t),!0}});var pt=L(E()),oe=class r{static getURL(e){return pt.default.runtime.getURL(e)}static get(e){return fetch(r.getURL(e))}static async getJSON(e){return await(await r.get(e)).json()}static async getText(e){return await(await r.get(e)).text()}};var se=class r{static{this.map={english:"en",bulgarian:"bg",czech:"cs",danish:"da",dutch:"nl",finnish:"fi",french:"fr",greek:"el",german:"de",hungarian:"hu",italian:"it",japanese:"ja",koreana:"ko",norwegian:"no",polish:"pl",portuguese:"pt-PT",brazilian:"pt-BR",russian:"ru",romanian:"ro",schinese:"zh-CN",spanish:"es-ES",latam:"es-419",swedish:"sv-SE",tchinese:"zh-TW",thai:"th",turkish:"tr",ukrainian:"ua",vietnamese:"vi"}}constructor(e){this._name=e,this._code=r.map[e]??null}get name(){return this._name}get code(){return this._code}isOneOf(...e){return e.includes(this._name)}};var _t=L(E());var re=class{static parse(e){let t=e.match(/(.*):\s(.+)/);return t?{name:t[1]??"",message:t[2]??""}:{name:null,message:null}}};var C=class{static async send(e,t={}){document.dispatchEvent(new CustomEvent("asRequestStart"));try{let o=await _t.default.runtime.sendMessage({action:e,params:t});return document.dispatchEvent(new CustomEvent("asRequestDone")),o}catch(o){let s=re.parse(o.message??"");throw document.dispatchEvent(new CustomEvent("asRequestError",{detail:s})),o}}};var ne=class{static wishlistAdd(e){return C.send("wishlist.add",{appid:e})}static wishlistRemove(e){return C.send("wishlist.remove",{appid:e})}static fetchAppDetails(e,t=void 0){return C.send("appdetails",{appid:e,filter:t})}static getPurchaseDate(e,t){return C.send("purchases",{appName:e,lang:t})}static getCurrency(){return C.send("currency")}static clearPurchases(){return C.send("clearpurchases")}static clearDynamicStore(){return C.send("dynamicstore.clear")}static getDynamicStoreStatus(e){return C.send("dynamicstore.status",{ids:e})}static getDynamicStoreRandomApp(){return C.send("dynamicstore.randomapp")}};var Y=class{static load(e){return oe.getJSON(`/localization/compiled/${e}.json`)}static async init(e){let t=y.language;e===null?e=new se(t):e.name!==t&&(y.language=e.name,ne.clearPurchases());let o=e.code??"en";try{this.locale=await this.load(o)}catch{console.error(`Failed to load ${o}`),this.locale=await this.load("en")}}};function Ee(r,e=null){let t=Y.locale.strings[r]??"<<missing text>>";if(e!==null)for(let[o,s]of Object.entries(e))t=t.replaceAll(`__${o}__`,String(s));return t}var z=L(E()),ie=class r{static{this.queryLinks={context_steam_store:[Ye,"https://store.steampowered.com/search/?term=__query__",()=>y.context_steam_store],context_steam_lucky:[Ze,"https://store.steampowered.com/search/?term=__query__&ifeellucky",()=>y.context_steam_lucky],context_steam_market:[Qe,"https://steamcommunity.com/market/search?q=__query__",()=>y.context_steam_market],context_itad:[Xe,"https://isthereanydeal.com/search/?q=__query__",()=>y.context_itad],context_bartervg:[et,"https://barter.vg/search?q=__query__",()=>y.context_bartervg],context_steamdb:[tt,"https://steamdb.info/search/?q=__query__",()=>y.context_steamdb],context_steamdb_instant:[ot,"https://steamdb.info/instantsearch/?query=__query__",()=>y.context_steamdb_instant],context_steam_keys:[st,"https://store.steampowered.com/account/registerkey?key=__query__",()=>y.context_steam_keys]}}static register(){z.default.runtime.onStartup.addListener(r.build),z.default.runtime.onInstalled.addListener(r.build),z.default.contextMenus.onClicked.hasListener(r.onClick)||z.default.contextMenus.onClicked.addListener(r.onClick)}static onClick(e){let t=r.queryLinks[e.menuItemId];if(!t)return;let o=t[1],s=e.selectionText.trim();if(e.menuItemId==="context_steam_keys"){let n=s.match(/[A-Z0-9]{5}(-[A-Z0-9]{5}){2}/g);Array.isArray(n)&&(s=n.join(","))}z.default.tabs.create({url:o.replace("__query__",encodeURIComponent(s))})}static async build(){await w.init(),await Y.init(null);for(let[e,t]of Object.entries(r.queryLinks)){let[o,s,n]=t;z.default.contextMenus.create({id:e,title:Ee(o,{query:"%s"}),contexts:["selection"],visible:n()},()=>z.default.runtime.lastError)}}static update(e){let t=this.queryLinks[e];if(!t)return;let[o,s,n]=t;z.default.contextMenus.update(e,{title:Ee(o,{query:"%s"}),contexts:["selection"],visible:n()})}};var Rt=(r,e)=>e.some(t=>r instanceof t),lt,ut;function Et(){return lt||(lt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Mt(){return ut||(ut=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var mt=new WeakMap,Le=new WeakMap,dt=new WeakMap,Me=new WeakMap,Be=new WeakMap;function Lt(r){let e=new Promise((t,o)=>{let s=()=>{r.removeEventListener("success",n),r.removeEventListener("error",i)},n=()=>{t(U(r.result)),s()},i=()=>{o(r.error),s()};r.addEventListener("success",n),r.addEventListener("error",i)});return e.then(t=>{t instanceof IDBCursor&&mt.set(t,r)}).catch(()=>{}),Be.set(e,r),e}function Ot(r){if(Le.has(r))return;let e=new Promise((t,o)=>{let s=()=>{r.removeEventListener("complete",n),r.removeEventListener("error",i),r.removeEventListener("abort",i)},n=()=>{t(),s()},i=()=>{o(r.error||new DOMException("AbortError","AbortError")),s()};r.addEventListener("complete",n),r.addEventListener("error",i),r.addEventListener("abort",i)});Le.set(r,e)}var Oe={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return Le.get(r);if(e==="objectStoreNames")return r.objectStoreNames||dt.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return U(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function gt(r){Oe=r(Oe)}function Bt(r){return r===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){let o=r.call(Pe(this),e,...t);return dt.set(o,e.sort?e.sort():[e]),U(o)}:Mt().includes(r)?function(...e){return r.apply(Pe(this),e),U(mt.get(this))}:function(...e){return U(r.apply(Pe(this),e))}}function Ft(r){return typeof r=="function"?Bt(r):(r instanceof IDBTransaction&&Ot(r),Rt(r,Et())?new Proxy(r,Oe):r)}function U(r){if(r instanceof IDBRequest)return Lt(r);if(Me.has(r))return Me.get(r);let e=Ft(r);return e!==r&&(Me.set(r,e),Be.set(e,r)),e}var Pe=r=>Be.get(r);function ft(r,e,{blocked:t,upgrade:o,blocking:s,terminated:n}={}){let i=indexedDB.open(r,e),a=U(i);return o&&i.addEventListener("upgradeneeded",p=>{o(U(i.result),p.oldVersion,p.newVersion,U(i.transaction),p)}),t&&i.addEventListener("blocked",p=>t(p.oldVersion,p.newVersion,p)),a.then(p=>{n&&p.addEventListener("close",()=>n()),s&&p.addEventListener("versionchange",_=>s(_.oldVersion,_.newVersion,_))}).catch(()=>{}),a}var Wt=["get","getKey","getAll","getAllKeys","count"],Ut=["put","add","delete","clear"],Fe=new Map;function ht(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(Fe.get(e))return Fe.get(e);let t=e.replace(/FromIndex$/,""),o=e!==t,s=Ut.includes(t);if(!(t in(o?IDBIndex:IDBObjectStore).prototype)||!(s||Wt.includes(t)))return;let n=async function(i,...a){let p=this.transaction(i,s?"readwrite":"readonly"),_=p.store;return o&&(_=_.index(a.shift())),(await Promise.all([_[t](...a),s&&p.done]))[0]};return Fe.set(e,n),n}gt(r=>({...r,get:(e,t,o)=>ht(e,t)||r.get(e,t,o),has:(e,t)=>!!ht(e,t)||r.has(e,t)}));async function jt(r,e,t,o){if(e==0&&(r.createObjectStore("items"),r.createObjectStore("earlyAccessAppids"),r.createObjectStore("collection"),r.createObjectStore("waitlist"),r.createObjectStore("itadImport"),r.createObjectStore("purchases"),r.createObjectStore("notes")),e<5&&(e>=1&&(r.deleteObjectStore("storePageData"),r.deleteObjectStore("profiles"),r.deleteObjectStore("rates"),r.deleteObjectStore("coupons"),r.deleteObjectStore("giftsAndPasses"),r.deleteObjectStore("dynamicStore"),r.deleteObjectStore("packages")),e>=2&&(r.deleteObjectStore("workshopFileSizes"),r.deleteObjectStore("reviews")),e>=3&&r.deleteObjectStore("expiries"),e>=4&&r.deleteObjectStore("storeList"),r.createObjectStore("storePageData").createIndex("idx_expiry","expiry"),r.createObjectStore("profiles").createIndex("idx_expiry","expiry"),r.createObjectStore("rates").createIndex("idx_expiry","expiry"),r.createObjectStore("coupons").createIndex("idx_appid","appids",{unique:!1,multiEntry:!0}),r.createObjectStore("giftsAndPasses").createIndex("idx_appid","",{unique:!1,multiEntry:!0}),r.createObjectStore("dynamicStore").createIndex("idx_appid","",{unique:!1,multiEntry:!0}),r.createObjectStore("packages").createIndex("idx_expiry","expiry"),r.createObjectStore("workshopFileSizes").createIndex("idx_expiry","expiry"),r.createObjectStore("reviews").createIndex("idx_expiry","expiry"),r.createObjectStore("expiries").createIndex("idx_expiry",""),r.createObjectStore("storeList")),e<6){let s=await o.objectStore("collection").getAllKeys(),n=o.objectStore("collection");for(let i of s)n.put([],i)}console.log(`DB migrated, ${e} -> ${t}`)}var xt={upgrade:jt};var wt=L(E());var We=class extends j{constructor(){super(wt.default.storage.local)}},h=new We;var Ue=class{constructor(e){this.promise=new Promise(t=>setTimeout(t,e))}then(e){return this.promise.then(e)}},je=class{constructor(e,t){this._running=!1;this.onDone=e,this.duration=t,this.reset()}get running(){return this._running}reset(){typeof this.id<"u"&&clearTimeout(this.id),this.id=window.setTimeout(async()=>{await this.onDone(),this._running=!1},this.duration),this._running=!0}stop(){typeof this.id<"u"&&(clearTimeout(this.id),this.id=void 0),this._running=!1}},d=class{static timer(e){return new Ue(e)}static resettableTimer(e,t){return new je(e,t)}static now(){return Math.trunc(Date.now()/1e3)}static isInPast(e){return e<=this.now()}static isInFuture(e){return e>this.now()}};var c=class r{static init(){return this.promise||(this.promise=(async()=>{this.db=await ft("Augmented Steam",J.db_version,{upgrade:xt.upgrade,blocked(){console.error("Failed to upgrade database, there is already an open connection")}});let e=await h.get("db_cleanup");(!e||d.isInPast(e+86400))&&(console.log("Db cleanup"),await r.cleanup(),await h.set("db_cleanup",d.now()))})()),this.promise}static async cleanup(){let e=[],t=this.db.transaction(this.db.objectStoreNames,"readwrite"),o=await t.objectStore("expiries").index("idx_expiry").openCursor(IDBKeyRange.upperBound(d.now()));for(;o;){let s=o.key;this.db.objectStoreNames.contains(s)&&e.push(t.objectStore(s).clear()),e.push(o.delete()),o=await o.continue()}await Promise.all(e),await Promise.all([this.deleteExpiredEntries("packages","idx_expiry"),this.deleteExpiredEntries("storePageData","idx_expiry"),this.deleteExpiredEntries("profiles","idx_expiry"),this.deleteExpiredEntries("rates","idx_expiry"),this.deleteExpiredEntries("workshopFileSizes","idx_expiry"),this.deleteExpiredEntries("reviews","idx_expiry")])}static async deleteExpiredEntries(e,t){let n=await this.db.transaction(e,"readwrite").store.index(t).openCursor(IDBKeyRange.upperBound(d.now()));if(n)for(;n;)await n.delete(),n=await n.continue()}static async isStoreExpired(e){let t=await this.db.get("expiries",e);return!t||d.isInPast(t)}static async setStoreExpiry(e,t){return this.db.put("expiries",d.now()+t,e)}static async put(e,t,o){await this.db.put(e,t,o)}static async putMany(e,t){let o=this.db.transaction(e,"readwrite"),s=o.store;await Promise.all(t.map(([n,i])=>s.put(i,n))),await o.done}static async replaceAll(e,t){let o=this.db.transaction(e,"readwrite"),s=o.store;await s.clear(),t.length>0&&await Promise.all(t.map(([n,i])=>s.put(i,n))),await o.done}static async get(e,t){return await this.db.get(e,t)}static async getObject(e,t){let o=await this.db.transaction(e).store.openCursor(),s=Object.fromEntries(t.map(n=>[n,void 0]));for(;o;)s[o.key]=o.value,o=await o.continue();return s}static async getFromIndex(e,t,o){return await this.db.transaction(e).store.index(t).get(o)}static async delete(e,...t){for(let o of t)await this.db.delete(e,o)}static async clear(...e){let t=this.db.transaction([...e,"expiries"],"readwrite");for(let o of e)t.objectStore("expiries").delete(o),t.objectStore(o).clear()}static async contains(e,t){let s=this.db.transaction(e).store;return Object.fromEntries(await Promise.all(t.map(async n=>[n,await s.getKey(n)!==void 0])))}};var ze=class extends Error{constructor(e){super(e),this.name="LoginError"}},Ke=class extends Error{constructor(e){super(e),this.name="ServerOutageError"}},Ge=class extends Error{constructor(e){super(e),this.name="OAuth Unauthorized"}},qe=class extends Error{constructor(e,t){super(t),this.code=e}},He=class extends Error{constructor(e,t){super(e),this.featureName=t}},S={LoginError:ze,ServerOutageError:Ke,HTTPError:qe,FeatureDependencyError:He,OAuthUnauthorized:Ge};var D=class{constructor(e){this.origin=e}getUrl(e,t={}){let o=new URL(e,this.origin);for(let[s,n]of Object.entries(t))n!==void 0&&o.searchParams.set(s,String(n));return o}async fetchJson(e,t={}){let o=await fetch(e,t);if(!o.ok)throw new S.HTTPError(o.status,o.statusText);return await o.json()}async fetchText(e,t={}){let o=await fetch(e,t);if(!o.ok)throw new S.HTTPError(o.status,o.statusText);return await o.text()}};var H=class{static getVariable(e,t){if(typeof e=="string"){let o=e.match(t);return o&&o[1]?o[1]:null}for(let o of e.querySelectorAll("script"))if(o.textContent){let s=o.textContent.match(t);if(s)return s&&s[1]?s[1]:null}return null}static getStringVariable(e,t=document){let o=typeof e=="string"?new RegExp(`${e}\\s*=\\s*['"](.+?)['"];`):e;return this.getVariable(t,o)}static getIntVariable(e,t=document){let o=typeof e=="string"?new RegExp(`${e}\\s*=\\s*(.+?);`):e,s=this.getVariable(t,o);return s?Number(s):null}static getArrayVariable(e,t=document){let o=typeof e=="string"?new RegExp(`${e}\\s*=\\s*(\\[.+?]);`):e,s=this.getVariable(t,o);return s?JSON.parse(s):null}static getObjectVariable(e,t=document){let o=typeof e=="string"?new RegExp(`${e}\\s*=\\s*(\\{.+?});`):e,s=this.getVariable(t,o);return s?JSON.parse(s):null}};var Ve=L(E()),yt="html/offscreen_domparser.html",ae=class{async ensureDocument(){let e=await clients.matchAll();for(let t of e)if(t.url.endsWith(yt))return;return chrome.offscreen.createDocument({url:Ve.default.runtime.getURL(yt),reasons:["DOM_PARSER"],justification:"Parsing data from DOM"})}closeDocument(){chrome.offscreen.closeDocument()}async send(e,t){await this.ensureDocument();let o=await Ve.default.runtime.sendMessage({domparser:{op:e,html:t}});return this.closeDocument(),o}parseCurrencyFromWallet(e){return this.send("currencyFromWallet",e)}parseCurrencyFromApp(e){return this.send("currencyFromApp",e)}parseWorkshopFileSize(e){return this.send("workshopFileSize",e)}parseReviews(e){return this.send("reviews",e)}parsePurchaseDates(e){return this.send("purchaseDates",e)}};var K=class{static{this.parser=null}static getParser(){return this.parser||(this.parser=new ae),this.parser}};var ce=class extends D{constructor(){super("https://steamcommunity.com/")}async fetchPage(e){let t=await fetch(e,{credentials:"include"});if(!t.ok)throw new S.HTTPError(t.status,t.statusText);if(new URL(t.url).pathname==="/login/home/")throw new S.LoginError("community");return await t.text()}fetchBadgeInfo(e,t){let o=this.getUrl(`/profiles/${e}/ajaxgetbadgeinfo/${t}`);return this.fetchJson(o,{credentials:"include"})}async fetchWorkshopFileSize(e){let t=this.getUrl("/sharedfiles/filedetails/",{id:e}),o=await this.fetchText(t,{credentials:"include"}),n=await K.getParser().parseWorkshopFileSize(o);if(n===-1)throw new Error(`Couldn't find details block for item id "${e}"`);if(n===-2)throw new Error(`Invalid file size for item id "${e}"`);return n}async getWorkshopFileSize(e,t){let o=await c.get("workshopFileSizes",e);if(!o||d.isInPast(o.expiry)){if(t)return await c.delete("workshopFileSizes",e),null;o={size:await this.fetchWorkshopFileSize(e),expiry:d.now()+5*86400},await c.put("workshopFileSizes",o,e)}return o.size}async fetchReviews(e,t){let o=K.getParser(),s=[],n=0;for(let i=1;i<=t;i++){let a=this.getUrl(`${e}/recommended`,{p:i}),p=await this.fetchPage(a),_=await o.parseReviews(p);for(let f of _)f.default=n++,s.push(f)}return s}async getReviews(e,t){let o=await c.get("reviews",e);return(!o||d.isInPast(o.expiry))&&(o={data:await this.fetchReviews(e,t),expiry:d.now()+60*60},await c.put("reviews",o,e)),o.data}async login(e){if(!e)throw await this.logout(),new Error("Login endpoint needs a valid profile path");if(!e.startsWith("/id/")&&!e.startsWith("/profiles/"))throw await this.logout(),new Error(`Could not interpret ${e} as a valid profile path`);let t=await h.get("login");if(t?.profilePath===e)return t;let o=this.getUrl(e),s=await this.fetchText(o),i=H.getObjectVariable("g_rgProfileData",s)?.steamid;if(!i)throw new Error("Failed to retrieve steamID from profile");await this.logout(!0);let a={steamId:i,profilePath:e};return await h.set("login",a),a}async logout(e=void 0){e===void 0&&(e=await h.get("login")!==void 0),e&&await Promise.all([h.remove("login"),h.remove("storeCountry"),h.remove("currency")])}async setStoreCountry(e){await h.set("storeCountry",e)}async getStoreCountry(){return await h.get("storeCountry")??null}handle(e){switch(e.action){case"community.badgeinfo":return this.fetchBadgeInfo(e.params.steamId,e.params.appid);case"community.workshopFileSize":return this.getWorkshopFileSize(e.params.id,e.params.preventFetch);case"community.reviews":return this.getReviews(e.params.steamId,e.params.pages);case"community.login":return this.login(e.params.profilePath);case"community.logout":return this.logout(e.params.force??void 0);case"community.storecountry.set":return this.setStoreCountry(e.params.newCountry);case"community.storecountry.get":return this.getStoreCountry()}return b}};var V=class extends D{constructor(){super("https://store.steampowered.com/")}async fetchPage(e){let t=await fetch(e,{credentials:"include"});if(!t.ok)throw new S.HTTPError(t.status,t.statusText);if(new URL(t.url).pathname==="/login/")throw new S.LoginError("store");return await t.text()}async fetchPackageApps(e){let t=this.getUrl("/api/packagedetails/",{packageids:e}),s=(await this.fetchJson(t))[String(e)];return s&&s.success?s.data.apps.map(n=>n.id):[]}async getPackageApps(e){let t=new Map,o=[],s=await c.getObject("packages",e);for(let[n,i]of Object.entries(s))!i||d.isInPast(i.expiry)?o.push(Number(n)):t.set(Number(n),i.appids);if(o.length>0){let n=[];for(let i of o){let a=await this.fetchPackageApps(i);n.push([i,{appids:a,expiry:d.now()+86400}]),t.set(i,a)}n.length>0&&await c.putMany("packages",n)}return t}async wishlistAdd(e){let t,o=await this.fetchSessionId();if(o){let s=this.getUrl("/api/addtowishlist");t=await this.fetchJson(s,{method:"POST",credentials:"include",body:new URLSearchParams({sessionid:o,appid:String(e)})})}if(!t||!t.success)throw new Error(`Failed to add app ${e} to wishlist`);await this.clearDynamicStore()}async wishlistRemove(e){let t,o=await this.fetchSessionId();if(o){let s=this.getUrl("/api/removefromwishlist");t=await this.fetchJson(s,{method:"POST",credentials:"include",body:new URLSearchParams({sessionid:o,appid:String(e)})})}if(!t||!t.success)throw new Error(`Failed to remove app ${e} from wishlist`);await this.clearDynamicStore()}async getCurrencyFromWallet(e){let t=this.getUrl("/steamaccount/addfunds"),o=await this.fetchPage(t);return e.parseCurrencyFromWallet(o)}async getCurrencyFromApp(e){let t=this.getUrl("/app/220"),o=await this.fetchPage(t);return e.parseCurrencyFromApp(o)}async getCurrency(){let e=await h.get("currency");if(e&&d.isInFuture(e.expiry))return e.data;let t=K.getParser(),o=await this.getCurrencyFromWallet(t);if(!o&&(o=await this.getCurrencyFromApp(t),!o))throw new Error("Store currency could not be determined from app 220");return await h.set("currency",{data:o,expiry:d.now()+86400}),o}async fetchSessionId(){let e=this.getUrl("/about/"),t=await this.fetchPage(e);return H.getStringVariable("g_sessionID",t)}async fetchPurchaseDates(e){let t=this.getUrl("/account/licenses/",{l:e}),o=await this.fetchPage(t);return K.getParser().parsePurchaseDates(o)}async getPurchaseDate(e,t){if(await c.isStoreExpired("purchases")){let o=await this.fetchPurchaseDates(t);await c.putMany("purchases",o),await c.setStoreExpiry("purchases",86400)}return await c.get("purchases",e)??null}clearPurchases(){return c.clear("purchases")}async refreshDynamicStore(){if(!await c.isStoreExpired("dynamicStore"))return;let t=this.getUrl("dynamicstore/userdata"),o=await this.fetchJson(t,{cache:"no-cache"}),{rgOwnedApps:s,rgOwnedPackages:n,rgIgnoredApps:i,rgWishlist:a,rgFollowedApps:p}=o,_=[],f=[];for(let[k,P]of Object.entries(i)){let M=Number(k);P===0?_.push(M):P===2&&f.push(M)}await c.putMany("dynamicStore",[["ignored",_],["ignoredOwnedElsewhere",f],["ownedApps",s],["ownedPackages",n],["wishlisted",a],["followed",p]]),await c.setStoreExpiry("dynamicStore",5*60)}async getDynamicStoreStatus(e){await this.refreshDynamicStore();let s=c.db.transaction("dynamicStore").store.index("idx_appid"),n=[],i=[],a=[],p=[],_=[];for(let f of e){let k=f.split("/",2);if(k.length!=2)continue;let P=k[0],M=Number(k[1]),Ie=await s.getAllKeys(M);for(let Se of Ie)switch(Se){case"ignored":n.push(f);break;case"ignoredOwnedElsewhere":i.push(f);break;case"wishlisted":p.push(f);break;case"followed":_.push(f);break;case"ownedApps":P==="app"&&a.push(f);break;case"ownedPackages":P==="sub"&&a.push(f);break}}return{ignored:n,ignoredOwned:i,owned:a,wishlisted:p,followed:_}}async dynamicStoreRandomApp(){await this.refreshDynamicStore();let e=await c.get("dynamicStore","ownedApps");return!e||!Array.isArray(e)||e.length===0?null:e[Math.floor(Math.random()*e.length)]}async clearDynamicStore(){await c.clear("dynamicStore")}async fetchAppDetails(e,t=void 0){let o=this.getUrl("api/appdetails/",{appids:e,filter:t}),s=await this.fetchJson(o,{credentials:"include"}),n=String(e);if(s&&s[n]){let i=s[n];if(i.success)return i.data}return null}handle(e){switch(e.action){case"wishlist.add":return this.wishlistAdd(e.params.appid);case"wishlist.remove":return this.wishlistRemove(e.params.appid);case"appdetails":return this.fetchAppDetails(e.params.appid,e.params.filter??void 0);case"currency":return this.getCurrency();case"sessionid":return this.fetchSessionId();case"purchases":return this.getPurchaseDate(e.params.appName,e.params.lang);case"clearpurchases":return this.clearPurchases();case"dynamicstore.clear":return this.clearDynamicStore();case"dynamicstore.status":return this.getDynamicStoreStatus(e.params.ids);case"dynamicstore.randomapp":return this.dynamicStoreRandomApp()}return b}};var O={ApiServerHost:"https://api.augmentedsteam.com",PublicHost:"https://augmentedsteam.com",ITADApiServerHost:"https://api.isthereanydeal.com",ITADServer:"https://isthereanydeal.com",ITADClientId:"5fe78af07889f43a",ITADDiscord:"https://discord.gg/yn57q7f"};var G=L(E());var A=class{static{this.loadPromise=void 0}static load(){return this.loadPromise||(this.loadPromise=(async()=>{let e=await h.get("access_token");return e?d.isInPast(e.expiry)?(await h.remove("access_token"),null):e.token:null})()),this.loadPromise}static async create(e,t){await h.set("access_token",{token:e,expiry:d.now()+t}),this.loadPromise=void 0}static async clear(){await h.remove("access_token"),this.loadPromise=void 0}};var pe=class{constructor(){this.RedirectURI="https://isthereanydeal.com/connectaugmentedsteam"}generateString(e){let t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.~",o=new Uint8Array(e);return crypto.getRandomValues(o),o.reduce((s,n)=>s+t.charAt(Math.floor(n%t.length)),"")}async sha256(e){let o=new TextEncoder().encode(e),s=await crypto.subtle.digest("SHA-256",o);return String.fromCharCode(...new Uint8Array(s))}base64url(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async getResponseUrl(e){return new Promise((t,o)=>{let s=(i,a,p)=>{i===e&&a.url?.startsWith(this.RedirectURI)&&(G.default.tabs.onUpdated.removeListener(s),G.default.tabs.onRemoved.removeListener(n),G.default.tabs.remove(i),t(new URL(a.url)))},n=(i,a)=>{i===e&&(G.default.tabs.onUpdated.removeListener(s),G.default.tabs.onRemoved.removeListener(n),o())};G.default.tabs.onUpdated.addListener(s),G.default.tabs.onRemoved.addListener(n)})}async authorize(e){let t=this.generateString(64),o=this.generateString(30),s=new URL(`${O.ITADServer}/oauth/authorize/`);s.searchParams.set("response_type","code"),s.searchParams.set("client_id",O.ITADClientId),s.searchParams.set("redirect_uri",this.RedirectURI),s.searchParams.set("scope",e.join(" ")),s.searchParams.set("state",o),s.searchParams.set("code_challenge",this.base64url(await this.sha256(t))),s.searchParams.set("code_challenge_method","S256");let n=await G.default.tabs.create({url:s.toString()});if(!n.id)throw new Error("Missing tab id");let i=await this.getResponseUrl(n.id);if(i.searchParams.get("state")!==o)throw new Error("Failed to verify state parameter from URL fragment");let a=i.searchParams.get("code");if(!a)throw new Error("Failed to receive code");let p=new URL("oauth/token/",O.ITADServer),_=new URLSearchParams;_.set("grant_type","authorization_code"),_.set("client_id",O.ITADClientId),_.set("redirect_uri",this.RedirectURI),_.set("code",a),_.set("code_verifier",t);let k=await(await fetch(p,{method:"POST",body:_})).json(),P=k.access_token,M=k.expires_in;if(!P||!M)throw new Error("Authorization failed");await A.create(P,Number(M))}};var Z=class extends Error{constructor(e,t=void 0){super(t),this.name="OutOfCapacityError",this.ratio=e}};var _e=class{constructor(e=!1,t){this.closeToFull=e,this.utilization=t}};var le=class{async getNotesMap(){return new Map(Object.entries(await F.get("user_notes")??{}).map(([e,t])=>[Number(e),t]))}async get(...e){let t=new Map(e.map(s=>[s,null])),o=await F.get("user_notes");if(o)for(let[s,n]of Object.entries(o)){let i=Number(s);t.has(i)&&t.set(i,n)}return t}async set(e,t){let o=await this.getNotesMap();o.set(e,t);let s=Object.fromEntries(o.entries()),n=this.getNotesSize(s)/F.QUOTA_BYTES_PER_ITEM;if(n>1)throw new Z(n,"Can't set this user note, out of capacity");return await F.set("user_notes",s),new _e(n>.85,n)}async delete(e){let t=await this.getNotesMap();return t.delete(e),t.size>0?F.set("user_notes",Object.fromEntries(t.entries())):F.remove("user_notes")}async export(){let e=await this.getNotesMap();return Object.fromEntries(e.entries())}async import(e){let t=this.getNotesSize(e)/F.QUOTA_BYTES_PER_ITEM;if(t>1)throw new Z(t,"Import to synced storage failed, too much data for this adapter");return F.set("user_notes",e)}clear(){return F.remove("user_notes")}getNotesSize(e){return 10+JSON.stringify(e).length}};var bt=250,zt=40,Kt=84600,Gt=5*60,qt=15*60,Ht=15*60,Vt=2*60,$t=["wait_read","wait_write","coll_read","coll_write","notes_read","notes_write"],ue=class extends D{constructor(){super(O.ITADApiServerHost)}async fetchStoreList(){let e=this.getUrl("service/shops/v1"),t=await this.fetchJson(e);if(!Array.isArray(t))throw new Error("Can't read store list from response");return t.map(o=>({id:o.id,title:o.title}))}async fetchSteamIds(e){let t=this.getUrl("lookup/shop/61/id/v1"),o=await this.fetchJson(t,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(e)}),s=new Map;for(let[n,i]of Object.entries(o))if(i!==null)for(let a of i)s.set(a,n);return s}async fetchGameIds(e){let t=this.getUrl("lookup/id/shop/61/v1"),o=await this.fetchJson(t,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(e)}),s=new Map;for(let[n,i]of Object.entries(o))i!==null&&s.set(n,i);return s}async fetchCollection(){let e=await A.load();if(!e)return null;let t=await this.fetchJson(this.getUrl("/collection/games/v1"),{headers:{authorization:"Bearer "+e}});if(t.length===0)return null;let o=new Map;for(let a of t)o.set(a.id,[]);let s=await this.fetchJson(this.getUrl("/collection/copies/v1"),{headers:{authorization:"Bearer "+e}});for(let a of s){let p=a.game.id,_={redeemed:a.redeemed};a.shop&&(_.shop=a.shop.name),a.note&&(_.note=a.note),a.tags.length>0&&(_.tags=a.tags.map(f=>f.tag)),o.get(p)?.push(_)}let n=await this.fetchSteamIds([...o.keys()]),i=new Map;for(let[a,p]of n.entries())i.set(a,o.get(p)??[]);return i}async fetchWaitlist(){let e=await A.load();if(!e)return null;let t=this.getUrl("/waitlist/games/v1"),o=await this.fetchJson(t,{headers:{authorization:"Bearer "+e}});if(o.length===0)return null;let s=o.map(n=>n.id);return await this.fetchSteamIds(s)}async getStoreList(){if(await c.isStoreExpired("storeList")){let e=await this.fetchStoreList();return await c.replaceAll("storeList",e.map(t=>[t.id,t])),await c.setStoreExpiry("storeList",Kt),e}else return await c.db.getAll("storeList")}async isConnected(){return await A.load()!==null}async disconnect(){return await A.clear(),await h.remove("lastItadImport"),await h.remove("syncEvents"),c.clear("collection","waitlist","itadImport")}async getLastImport(){return await h.get("lastItadImport")??{from:null,to:null}}async recordLastImport(){let e=await this.getLastImport();e.from=d.now(),await h.set("lastItadImport",e)}async getSyncEvents(){return await h.get("syncEvents")??[]}async recordSyncEvent(e,t,o){let s=await this.getSyncEvents();s.unshift({section:e,type:t,timestamp:d.now(),count:o}),await h.set("syncEvents",s.slice(0,zt))}async removeFromWaitlist(e){let t=await A.load();if(!t)throw new Error("Missing access token");if(e.length===0)throw new Error("Can't remove nothing from ITAD Waitlist!");let o=e.map(n=>`app/${n}`),s=await Promise.all(o.map(n=>c.get("waitlist",n)));if(s=s.filter(n=>n),s.length>0){let n=this.getUrl("waitlist/games/v1"),i=await fetch(n,{method:"DELETE",headers:{authorization:"Bearer "+t},body:JSON.stringify(s)});if(!i.ok)throw new S.HTTPError(i.status,i.statusText);return c.delete("waitlist",...o)}}async addToWaitlist(e){let t=await A.load();if(!t)throw new Error("Missing access token");let o=e.map(n=>`app/${n}`),s=await this.fetchGameIds(o);if(s.size!==0){let n=await fetch(new URL("waitlist/games/v1",O.ITADApiServerHost),{method:"PUT",headers:{authorization:"Bearer "+t},body:JSON.stringify(Array.from(s.values()))});if(!n.ok)throw new S.HTTPError(n.status,n.statusText);return c.putMany("waitlist",[...s])}}async addToCollection(e,t){let o=await A.load();if(!o)throw new Error("Missing access token");let s=[...e.map(i=>`app/${i}`),...t.map(i=>`sub/${i}`)];if(s.length===0)return;let n=await this.fetchGameIds(s);if(n.size!==0&&(await fetch(new URL("collection/games/v1",O.ITADApiServerHost),{method:"PUT",headers:{authorization:"Bearer "+o},body:JSON.stringify(Array.from(n.values()))})).ok)return c.putMany("collection",[...n.keys()].map(a=>[a,[]]))}async exportToItad(e){if(await w.load(),!y.itad_sync_library&&!y.itad_sync_wishlist)return;if(!e){let o=await this.getLastImport();if(o.to&&d.isInFuture(o.to+Gt))return}if(y.itad_sync_library){let o=c.db.transaction(["dynamicStore","itadImport"]),s=o.objectStore("dynamicStore"),n=o.objectStore("itadImport"),i=new Set(await n.get("lastOwnedApps")??[]),a=new Set(await n.get("lastOwnedPackages")??[]),p=await s.get("ownedApps")??[],_=await s.get("ownedPackages")??[];await o.done;let f=p.filter(P=>e||!i.has(P)),k=_.filter(P=>e||!a.has(P));(f.length>0||k.length>0)&&(await this.addToCollection(f,k),await c.putMany("itadImport",[["lastOwnedApps",p],["lastOwnedPackages",_]])),await this.recordSyncEvent("collection","push",f.length+k.length)}if(y.itad_sync_wishlist){let o=c.db.transaction(["dynamicStore","itadImport"]),s=o.objectStore("dynamicStore"),n=o.objectStore("itadImport"),i=new Set(await n.get("lastWishlisted")??[]),a=await s.get("wishlisted")??[];await o.done;let p=a.filter(_=>e||!i.has(_));p.length>0&&(await this.addToWaitlist(p),await c.put("itadImport",a,"lastWishlisted")),await this.recordSyncEvent("waitlist","push",p.length)}let t=await this.getLastImport();t.to=d.now(),await h.set("lastItadImport",t)}async importWaitlist(e){if(await w.load(),!!y.itad_sync_wishlist&&(e||await c.isStoreExpired("waitlist"))){let t=await this.fetchWaitlist();await c.replaceAll("waitlist",t?[...t.entries()]:[]),await c.setStoreExpiry("waitlist",qt),await this.recordLastImport(),await this.recordSyncEvent("waitlist","pull",t?.size??0)}}async importCollection(e){if(await w.load(),!!y.itad_sync_library&&(e||await c.isStoreExpired("collection"))){let t=await this.fetchCollection();await c.replaceAll("collection",t?[...t.entries()]:[]),await c.setStoreExpiry("collection",Ht),await this.recordLastImport(),await this.recordSyncEvent("collection","pull",t?.size??0)}}async sync(e){await w.load(),await this.exportToItad(e),await this.importWaitlist(e),await this.importCollection(e),y.itad_sync_notes&&await this.pullNotes(e)}async inWaitlist(e){return await this.importWaitlist(!1),c.contains("waitlist",e)}async inCollection(e){return await this.importCollection(!1),c.contains("collection",e)}async getFromCollection(e){return await this.importCollection(!1),await c.get("collection",e)??null}async pullNotes(e){if(await w.load(),!e&&!await c.isStoreExpired("notes"))return 0;let t=await A.load();if(!t)throw new S.OAuthUnauthorized;let o=await this.fetchJson(this.getUrl("/user/notes/v1"),{method:"GET",headers:{authorization:"Bearer "+t,accept:"application/json"}}),s=new Map;if(o.length!==0){let n=new Map(o.map(a=>[a.gid,a.note])),i=await this.fetchSteamIds([...n.keys()]);for(let[a,p]of i){if(!a.startsWith("app/"))continue;let _=Number(a.substring(4)),f=n.get(p);s.set(_,f)}switch(y.user_notes_adapter){case"synced_storage":let a=new le;for(let[p,_]of s)await a.set(p,_);break;case"idb":await c.putMany("notes",[...s.entries()].map(([p,_])=>[Number(p),_]));break}}return await c.setStoreExpiry("notes",Vt),await this.recordLastImport(),await this.recordSyncEvent("notes","pull",s.size),s.size}async pushNotes(e){let t=await A.load();if(!t)throw new S.OAuthUnauthorized;let o={pushed:0,errors:[]};if(e.length===0)return o;let s=new Map(e),n=[...s.keys()].map(p=>`app/${p}`),i=await this.fetchGameIds(n),a=[];for(let[p,_]of s.entries()){if(_=_.trim(),_===""){o.errors.push([p,rt,null]);continue}if(_.length>bt){o.errors.push([p,it,{length:_.length,max:bt}]);continue}let f=i.get(`app/${p}`)??null;if(f===null){o.errors.push([p,nt,null]);continue}a.push({gid:f,note:_})}if(a.length!==0){let p=await fetch(this.getUrl("/user/notes/v1"),{method:"PUT",headers:{authorization:"Bearer "+t,"content-type":"application/json",accept:"application/json"},body:JSON.stringify(a)});if(!p.ok)throw new S.HTTPError(p.status,p.statusText)}return o.pushed=a.length,await this.recordSyncEvent("notes","push",o.pushed),o}async deleteNotes(e){let t=await A.load();if(!t)throw new S.OAuthUnauthorized;let o=await this.fetchGameIds(e.map(n=>`app/${n}`)),s=await fetch(this.getUrl("/user/notes/v1"),{method:"DELETE",headers:{authorization:"Bearer "+t,"content-type":"application/json"},body:JSON.stringify([...o.values()])});if(!s.ok)throw new S.HTTPError(s.status,s.statusText)}handle(e){switch(e.action){case"itad.storelist":return this.getStoreList();case"itad.authorize":return new pe().authorize($t);case"itad.disconnect":return this.disconnect();case"itad.isconnected":return this.isConnected();case"itad.export":return this.exportToItad(e.params.force);case"itad.sync":return this.sync(e.params.force);case"itad.lastimport":return this.getLastImport();case"itad.syncevents":return this.getSyncEvents();case"itad.inwaitlist":return this.inWaitlist(e.params.storeIds);case"itad.addtowaitlist":return this.addToWaitlist(e.params.appids);case"itad.removefromwaitlist":return this.removeFromWaitlist(e.params.appids);case"itad.incollection":return this.inCollection(e.params.storeIds);case"itad.getfromcollection":return this.getFromCollection(e.params.storeId);case"itad.notes.pull":return this.pullNotes(!0);case"itad.notes.push":return this.pushNotes(e.params.notes);case"itad.notes.delete":return this.deleteNotes(e.params.appids)}return b}};var me=class extends D{constructor(){super(O.ApiServerHost)}fetchStorePageData(e){let t=this.getUrl(`app/${e}/v2`);return this.fetchJson(t)}fetchRates(e){let t=this.getUrl("rates/v1",{to:e.join(",")});return this.fetchJson(t)}fetchEarlyAccess(){let e=this.getUrl("early-access/v1");return this.fetchJson(e)}fetchSteamPeek(e){let t=this.getUrl(`similar/${e}/v2`,{count:15});return this.fetchJson(t)}fetchDlcInfo(e){let t=this.getUrl(`dlc/${e}/v2`);return this.fetchJson(t)}fetchProfile(e){let t=this.getUrl(`profile/${e}/v2`);return this.fetchJson(t)}fetchTwitch(e){let t=this.getUrl(`twitch/${e}/stream/v2`);return this.fetchJson(t)}fetchProfileBackgrounds(e){let t=this.getUrl("profile/background/list/v2",{appid:e});return this.fetchJson(t)}fetchProfileBackgroundsGames(){let e=this.getUrl("profile/background/games/v1");return this.fetchJson(e)}fetchMarketAverageCardPrices(e,t){let o=this.getUrl("market/cards/average-prices/v2",{currency:e,appids:t.join(",")});return this.fetchJson(o)}fetchPrices(e,t,o,s,n,i){let a=this.getUrl("prices/v2");return this.fetchJson(a,{method:"POST",body:JSON.stringify({country:e,apps:t,subs:o,bundles:s,voucher:n,shops:i})})}async getProfileData(e){let o=await c.get("profiles",e);return(!o||d.isInPast(o.expiry))&&(o={data:await this.fetchProfile(e),expiry:d.now()+86400},await c.put("profiles",o,e)),o.data}clearOwn(e){return c.delete("profiles",e)}async getStorePageData(e){let o=await c.get("storePageData",e);return(!o||d.isInPast(o.expiry))&&(o={data:await this.fetchStorePageData(e),expiry:d.now()+3600},await c.put("storePageData",o,e)),o.data}expireStorePageData(e){return c.delete("storePageData",e)}async getRates(e){let o=e.join(","),s=await c.get("rates",o);return(!s||d.isInPast(s.expiry))&&(s={data:await this.fetchRates(e),expiry:d.now()+3600},await c.put("rates",s,o)),s.data}clearRates(){return c.clear("rates")}async isEarlyAccess(e){if(await c.isStoreExpired("earlyAccessAppids")){let s=await this.fetchEarlyAccess();await c.replaceAll("earlyAccessAppids",s.map(n=>[n,n])),await c.setStoreExpiry("earlyAccessAppids",7200)}return c.contains("earlyAccessAppids",e)}handle(e){switch(e.action){case"prices":{let{country:t,apps:o,subs:s,bundles:n,voucher:i,shops:a}=e.params;return this.fetchPrices(t,o,s,n,i,a)}case"dlcinfo":return this.fetchDlcInfo(e.params.appid);case"storepagedata":return this.getStorePageData(e.params.appid);case"storepagedata.expiry":return this.expireStorePageData(e.params.appid);case"rates":return this.getRates(e.params.to);case"clearrates":return this.clearRates();case"isea":return this.isEarlyAccess(e.params.appids);case"profile.background":return this.fetchProfileBackgrounds(e.params.appid);case"profile.background.games":return this.fetchProfileBackgroundsGames();case"twitch.stream":return this.fetchTwitch(e.params.channelId);case"market.averagecardprices":return this.fetchMarketAverageCardPrices(e.params.currency,e.params.appids);case"steampeek":return this.fetchSteamPeek(e.params.appid);case"profile":return this.getProfileData(e.params.steamId);case"clearownprofile":return this.clearOwn(e.params.steamId)}return b}};var de=class{getNote(e){return c.getObject("notes",e)}async setNote(e,t){await c.put("notes",t,e)}deleteNote(e){return c.delete("notes",e)}async getAllNotes(){let t=await c.db.transaction("notes").store.openCursor(),o={};for(;t;)o[t.key]=t.value,t=await t.continue();return o}async setAllNotes(e){return await this.clearNotes(),c.putMany("notes",Object.entries(e).map(([t,o])=>[Number(t),o]))}clearNotes(){return c.clear("notes")}handle(e){switch(e.action){case"notes.get":return this.getNote(e.params.appids);case"notes.set":return this.setNote(e.params.appid,e.params.note);case"notes.delete":return this.deleteNote(e.params.appid);case"notes.getall":return this.getAllNotes();case"notes.setall":return this.setAllNotes(e.params.notes);case"notes.clear":return this.clearNotes()}return b}};var Te=L(E());var ge=class{constructor(e,t){this.type_=e;this.id_=t;this.full=`${this.type_}/${this.id_}`}get type(){return this.type_}get number(){return this.id_}get string(){return this.full}};var Q=class extends ge{static fromUrl(e){let t=e.match(/(?:store\.steampowered|steamcommunity)\.com\/(?:app|games|market\/listings)\/(\d+)\/?/);return t&&t[1]!==void 0?Number(t[1]):null}static fromCDNUrl(e){let t=/(?:cdn\.(?:(?:akamai|cloudflare|fastly)\.)?steamstatic\.com\/steam|steamcdn-a\.akamaihd\.net\/steam|steamcommunity\/public\/images)\/apps\/(\d+)\//,o=/shared\.(?:(?:akamai|cloudflare|fastly)\.)?steamstatic\.com\/store_item_assets\/steam\/apps\/(\d+)\//,s=e.match(t)??e.match(o);return s&&s[1]!==void 0?Number(s[1]):null}static fromGameCardUrl(e){let t=e.match(/\/gamecards\/(\d+)/);return t&&t[1]!==void 0?Number(t[1]):null}static fromElement(e){if(!e)return null;let t=e.dataset.dsAppid;if(t)return Number(t);let o=e.getAttribute("href");return o?this.fromUrl(o):null}static fromImageElement(e){if(!e)return null;let t=e.getAttribute("src");return t?this.fromCDNUrl(t):e.dataset.imageUrl?this.fromCDNUrl(e.dataset.imageUrl):null}static fromText(e){let t=/(?:store\.steampowered|steamcommunity)\.com\/app\/(\d+)\/?/g,o=[],s;for(;(s=t.exec(e))!==null;)o.push(Number(s[1]));return o}constructor(e){super("app",e)}};var he=class extends D{constructor(){super("https://steamcommunity.com/")}async loadInventory(e){let t=await h.get("login");if(!t||!t.steamId)return console.warn("Must be signed in to access Inventory"),null;let o=null,s=new URL(`/inventory/${t.steamId}/753/${e}`,"https://steamcommunity.com/");s.searchParams.set("l","english"),s.searchParams.set("count","2000");let n=!1;do{n=!1;let i=await fetch(s,{credentials:"include"});if(!i.ok)throw i.status===403?new S.LoginError("community"):new S.HTTPError(i.status,i.statusText);let a=await i.json();a&&a.success&&(o||(o={assets:[],descriptions:[]}),a.assets&&o.assets.push(...a.assets),a.descriptions&&o.descriptions.push(...a.descriptions),a.last_assetid&&s.searchParams.set("start_assetid",a.last_assetid),a.more_items&&(n=!0))}while(n);if(!o)throw new Error(`Could not retrieve Inventory 753/${e}`);return o}async fetchCoupons(){let e=await this.loadInventory(3);if(!e)return null;let t=new Map;for(let s of e.descriptions){if(!s.type||s.type!=="Coupon"||!s.actions)continue;let n={appids:[],image_url:s.icon_url,title:s.name,discount:Number(s.name.match(/([1-9][0-9])%/)[1]),id:`${s.classid}_${s.instanceid}`};s.descriptions.forEach((i,a)=>{let p=i.value;p.startsWith("Can't be applied with other discounts.")?(n.discount_note=p,n.discount_note_id=a,n.discount_doesnt_stack=!0):p.startsWith("(Valid")&&(n.valid_id=a,n.valid=p)});for(let i of s.actions){let a=i.link.match(/[1-9][0-9]*(?:,[1-9][0-9]*)*/);if(!a){console.warn("Couldn't find packageid(s) for link %s",i.link);continue}for(let p of a[0].split(",")){let _=Number(p);(!t.has(_)||t.get(_).discount<n.discount)&&t.set(_,n)}}}let o=await new V().getPackageApps([...t.keys()]);for(let[s,n]of t.entries())n.appids=o.get(s)??[];return t}async fetchGiftsAndPasses(){let e=await this.loadInventory(1);if(!e)return null;let t=[],o=[],s=!1;for(let n of e.descriptions){let i=n.descriptions?.find(a=>a.type==="html");if(i){let a=Q.fromText(i.value);if(a.length>0){s=!0;for(let p of a)n.type==="Gift"?t.push(p):o.push(p)}}if(!s&&n.actions&&n.actions.length>1){let a=Q.fromUrl(n.actions[0].link);a&&(n.type==="Gift"?t.push(a):o.push(a))}}return{gifts:t,passes:o}}async fetchItems(){let e=await this.loadInventory(6);return e?e.descriptions.map(t=>t.market_hash_name):null}async refreshCoupons(){return this.refreshCouponsPromise||(this.refreshCouponsPromise=(async()=>{if(await c.isStoreExpired("coupons")){let t=await this.fetchCoupons();t===null?await c.clear("coupons"):(await c.replaceAll("coupons",[...t.entries()]),await c.setStoreExpiry("coupons",60*60))}})()),this.refreshCouponsPromise}async getCoupon(e){return await this.refreshCoupons(),c.getFromIndex("coupons","idx_appid",e)}async getCouponsAppids(e){await this.refreshCoupons();let t=c.db.transaction("coupons"),o=new Set(await t.store.index("idx_appid").getAllKeys()),s=[];for(let n of e)o.has(n)&&s.push("app/"+n);return await t.done,s}async refreshGiftsAndPasses(){return this.refreshGiftsPromise||(this.refreshGiftsPromise=(async()=>{if(await c.isStoreExpired("giftsAndPasses")){let t=await this.fetchGiftsAndPasses();t===null?await c.clear("giftsAndPasses"):(await c.replaceAll("giftsAndPasses",[["gifts",t.gifts],["passes",t.passes]]),await c.setStoreExpiry("giftsAndPasses",60*60))}})()),this.refreshGiftsPromise}async getGiftsAppids(e){await this.refreshGiftsAndPasses();let t=c.db.transaction("giftsAndPasses"),o=new Set(await t.store.get("gifts")??[]),s=[];for(let n of e)o.has(n)&&s.push("app/"+n);return await t.done,s}async getPassesAppids(e){await this.refreshGiftsAndPasses();let t=c.db.transaction("giftsAndPasses"),o=new Set(await t.store.get("passes")??[]),s=[];for(let n of e)o.has(n)&&s.push("app/"+n);return await t.done,s}async hasItem(e){if(await c.isStoreExpired("items")){let o=await this.fetchItems();o===null?await c.clear("items"):(await c.replaceAll("items",o.map(s=>[s,s])),await c.setStoreExpiry("items",60*60))}return await c.contains("items",e)}handle(e){switch(e.action){case"inventory.coupon":return this.getCoupon(e.params.appid);case"inventory.getCouponAppids":return this.getCouponsAppids(e.params.appids);case"inventory.getGiftsAppids":return this.getGiftsAppids(e.params.appids);case"inventory.getPassesAppids":return this.getPassesAppids(e.params.appids);case"inventory.hasItem":return this.hasItem(e.params.hashes)}return b}};var X=class{async clearCache(){await h.remove("currency","market_stats","market_stats2"),await c.clear("coupons","giftsAndPasses","items","earlyAccessAppids","purchases","dynamicStore","packages","profiles","rates","collection","waitlist","itadImport","workshopFileSizes","reviews","storeList","storePageData","expiries")}handle(e){switch(e.action){case"cache.clear":return this.clearCache()}return b}};var fe=class{static{this.currentContext=0}static set CurrentContext(e){this.currentContext=e}static isBackgroundScript(){return this.currentContext===1}static isContentScript(){return this.currentContext===2}static isOptions(){return this.currentContext===3}};var xe=class r{constructor(e,t=0,o=0){console.assert([e,t,o].filter(Number.isInteger).length===3,`${e}.${t}.${o} must be integers`),this.major=e,this.minor=t,this.patch=o}static from(e){if(e instanceof r)return new r(e.major,e.minor,e.patch);if(typeof e=="string")return r.fromString(e);if(Array.isArray(e))return r.fromArray(e);throw new Error(`Could not construct a Version from ${e}`)}static fromArray(e){if(e.length===0)throw new Error;return new r(Number(e[0]),Number(e[1]??0),Number(e[2]??0))}static fromString(e){return r.fromArray(e.split("."))}static coerce(e){return e instanceof r?e:r.from(e)}toString(){return`${this.major}.${this.minor}.${this.patch}`}toArray(){return[this.major,this.minor,this.patch]}toJSON(){return this.toString()}isCurrent(){return this.isSameOrAfter(J.version)}isSame(e){let t=r.coerce(e);return this.major===t.major&&this.minor===t.minor&&this.patch===t.patch}isBefore(e){let t=r.coerce(e);return this.major<t.major?!0:this.major>t.major?!1:this.minor<t.minor?!0:this.minor>t.minor?!1:this.patch<t.patch}isSameOrBefore(e){return this.isSame(e)||this.isBefore(e)}isAfter(e){return r.coerce(e).isBefore(this)}isSameOrAfter(e){return r.coerce(e).isSameOrBefore(this)}};var we=class{static async migrate(e){let t=new q;if(e.isSameOrBefore("2.0.0")&&(await t.remove("showfakeccwarning"),await t.remove("hideaboutlinks")),e.isSameOrBefore("2.0.1")){await t.remove("hide_dlcunownedgames"),await t.remove("hide_wishlist"),await t.remove("hide_cart"),await t.remove("hide_notdiscounted"),await t.remove("hide_mixed"),await t.remove("hide_negative"),await t.remove("hide_priceabove"),await t.remove("priceabove_value"),await t.remove("hide_owned"),await t.remove("hide_ignored"),await t.remove("highlight_notdiscounted"),await t.remove("showallfriendsthatown");let o=t.get("showusernotes");o!==void 0&&(await w.set("user_notes_app",!!o),await w.set("user_notes_wishlist",!!o),await t.remove("showusernotes"))}if(e.isSameOrBefore("2.1.0")){await t.remove("showcomparelinks");let o=await t.get("profile_custom_link");for(let s of o)s.url&&!s.url.includes("[ID]")&&(s.url+="[ID]");await w.set("profile_custom_link",o)}if(e.isSameOrBefore("2.3.3")){let o=await t.get("customize_apppage");for(let s of["steamchart","surveys","steamspy"])Object.prototype.hasOwnProperty.call(o,s)&&typeof o[s]=="boolean"&&delete o[s];await w.set("customize_apppage",o)}if(e.isSameOrBefore("2.4.1")&&await t.remove("showallachievements"),e.isSameOrBefore("2.5.0")&&await t.remove("replaceaccountname"),e.isSameOrBefore("3.0.0")){let o={adventureshop:1,allyouplay:2,amazonus:3,battlenet:4,bistore:5,bundlestars:6,coinplay:7,cybermanta:8,desura:9,digitaldownload:10,direct2drive:11,discord:12,dlgamer:13,dotemu:14,dreamgame:15,epic:16,fireflower:17,funstock:18,game2:19,gamebillet:20,gamefly:21,gamejolt:22,gameolith:23,gamersgate:24,gamesload:25,gamesplanet:26,gamesplanetde:27,gamesplanetfr:28,gamesplanetus:29,gamesrepublic:30,gamesrocket:31,gametap:32,gemly:33,getgames:34,gog:35,greenmangaming:36,humblestore:37,humblewidgets:38,chrono:39,imperialgames:40,impulse:41,indiegalastore:42,indiegamestand:43,itchio:44,lbostore:45,less4games:46,macgamestore:47,microsoft:48,newegg:49,nuuvem:50,oculus:51,origin:52,paradox:53,playfield:54,playism:55,razer:56,savemi:57,shinyloot:58,silagames:59,squenix:60,steam:61,uplay:62,voidu:63,wingamestore:64,joybuggy:65,noctre:66,etailmarket:67},s=await t.get("excluded_stores");await w.set("excluded_stores",s.map(n=>o[n]??null).filter(n=>n))}e.isSameOrBefore("3.1.0")&&(await t.remove("addtocart_no_redirect"),await t.remove("show_steamspy_info"),await t.remove("show_survey_info"),await t.remove("show_steamchart_info")),e.isSameOrBefore("4.0.1")&&(await w.set("itad_sync_library",await t.get("itad_import_library")??!0),await w.set("itad_sync_wishlist",await t.get("itad_import_wishlist")??!0),await t.remove("itad_import_library"),await t.remove("itad_import_wishlist"),await A.clear()),e.isSameOrBefore("4.1.2")&&await t.remove("showdeckcompat")}};var ee=L(E()),ye=class{constructor(){this.listeners=new Map}unregister(e){console.log(`Unregister webrequest listeners for tab ${e}, tab no longer exists`);let t=this.listeners.get(e)??new Map;for(let o of t.values())ee.webRequest.onCompleted.removeListener(o);this.listeners.delete(e)}async register(e,t,o){let s=async i=>{try{await ee.default.tabs.get(e)}catch{this.unregister(e);return}ee.default.tabs.sendMessage(e,{key:t,url:i.url})},n=this.listeners.get(e)??new Map;n.has(t)||(n.set(t,s),this.listeners.set(e,n),ee.webRequest.onCompleted.addListener(s,{urls:o}))}handle(e,t){if(!t.id)throw new Error("Requires tab");switch(e.action){case"listener.register":return this.register(t.id,e.params.key,e.params.urls)}return b}};var be=class{#e=new Map;setValue(e,t,o){this.#e.set(e+"/"+t,o)}getValue(e,t){return this.#e.get(e+"/"+t)??null}handle(e){switch(e.action){case"sess.cache.set":return this.setValue(e.params.prefix,e.params.key,e.params.value),Promise.resolve();case"sess.cache.get":return Promise.resolve(this.getValue(e.params.prefix,e.params.key))}return b}};fe.CurrentContext=1;var b=Symbol("Unrecognized");Te.default.runtime.onInstalled.addListener(async r=>{if(r.reason!=="update"||r.previousVersion===void 0)return;let e=xe.fromString(r.previousVersion);await c.init(),await we.migrate(e),await new X().handle("cache.clear"),await async function(){await new j(Te.default.storage.local).remove("es_guide_tags")}(),console.log("Update done")});var Jt=[new me,new ce,new he,new ue,new V,new de,new ye,new X,new be];Te.default.runtime.onMessage.addListener((r,e)=>{if(!(!e||!e.tab)&&!(!r||!r.action))return(async()=>{try{await Promise.all([c.init(),w.init()]);let t;for(let o of Jt)if(t=await o.handle(r,e.tab),t!==b)break;if(t===b)throw new Error("Unknown message");return t}catch(t){throw console.group(`Callback: "${r.action}"`),console.error("Failed to execute %o",r),console.error(t),console.groupEnd(),new Error(t.toString())}})()});ie.register();return Nt(Yt);})();
//# sourceMappingURL=background.js.map
