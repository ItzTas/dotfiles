#!/bin/env bash
# vim=sh

create_packagelists() {
    local package_lists_dir="${XDG_CONFIG_DIR:-$HOME/.config}/yadm/packagelists"
    mkdir -p "$package_lists_dir"

    local device_id
    # device_id=$(findmnt -no UUID / 2>/dev/null || echo "unknown")
    #
    # if [ "$device_id" = "unknown" ] || [ "$device_id" = "" ]; then
    #     device_id=$(printf "%s" "$(hostname)-$USER" | sha256sum | cut -c1-12)
    # fi
    device_id=$(printf "%s" "$(hostname)-$USER" | sha256sum | cut -c1-12)

    local pacman_list="$package_lists_dir/pacmanlist_${device_id}"
    local flatpak_list="$package_lists_dir/flatpaklist_${device_id}"

    pacman -Q >"$pacman_list"
    flatpak list --app --columns=application >"$flatpak_list"

    echo "$pacman_list $flatpak_list"
}

yadm_update() {
    (
        set -e

        local pacman_list flatpak_list
        read -r pacman_list flatpak_list < <(create_packagelists)

        if command -v diff-so-fancy &>/dev/null; then
            yadm --no-pager diff | diff-so-fancy
        else
            yadm --no-pager diff
        fi

        yadm add "$pacman_list"
        yadm add "$flatpak_list"

        yadm add "$HOME/Pictures/.backgrounds"
        yadm add "$HOME/.config/yadm/bootstrap.x.d"
        yadm add "$HOME/.config/hypr/config"
        yadm add "$HOME/.local/share/millennium"
        yadm add -u

        local status_output filtered_output files

        status_output=$(yadm status -s)

        filtered_output=$(echo "$status_output" | grep -vE '^\s*##' || true)
        if [ "$filtered_output" = "" ]; then
            yadm push
            return
        fi
        files=$(echo "$filtered_output" | awk '{$1=$1; print}' | tr '\n' ', ')
        files="${files%, }"

        local commit_msg
        commit_msg="$(date '+%Y-%m-%d %H:%M') - Updated: $files"

        local max_len=600

        if [ ${#commit_msg} -gt "$max_len" ]; then
            commit_msg="automated update"
        fi

        yadm commit -m "$commit_msg"
        yadm push
    )
}

yadm_update
