#!/bin/env bash
# vim=sh

yadm_update() {
    (
        set -e

        local package_lists_dir="${XDG_CONFIG_DIR:-$HOME/.config/}/yadm/packagelists"
        mkdir -p "$package_lists_dir"

        pacman -Q >"$package_lists_dir/pacmanlist"
        yadm add "$package_lists_dir/pacmanlist"

        flatpak list --app --columns=application >"$package_lists_dir/flatpaklist"
        yadm add "$package_lists_dir/flatpaklist"

        if command -v diff-so-fancy &>/dev/null; then
            yadm --no-pager diff | diff-so-fancy
        else
            yadm --no-pager diff
        fi

        yadm add "$HOME/Pictures/.backgrounds"
        yadm add "$HOME/.config/yadm/bootstrap.x.d"
        yadm add "$HOME/.config/hypr/config"
        yadm add -u :/

        local files
        files=$(yadm status -s | grep -vE '^\s*##' | awk '{print $2}' | tr '\n' ', ')

        files="${files%, }"

        local commit_msg
        commit_msg="$(date '+%Y-%m-%d %H:%M') - Updated: $files"

        yadm commit -m "$commit_msg"
        yadm push
    )
}

yadm_update
