#!/bin/env bash
# vim=sh

yadm_update() {
    (
        set -e

        pacman -Q >"$HOME"/.pacmanlist
        flatpak list --app --columns=application >"$HOME/.flatpaklist"

        if command -v diff-so-fancy &>/dev/null; then
            yadm --no-pager diff | diff-so-fancy
        else
            yadm --no-pager diff
        fi

        yadm add "$HOME/.pacmanlist"
        yadm add "$HOME/.flatpaklist"
        yadm add "$HOME/Pictures/.backgrounds"
        yadm add "$HOME/.config/yadm/bootstrap.x.d"
        yadm add "$HOME/.config/hypr/config"
        yadm add -u :/

        local files
        files=$(yadm status -s | awk '{print $1 " " $2}' | tr '\n' ', ')

        local commit_msg
        commit_msg="$(date '+%Y-%m-%d %H:%M') - Updated: $files"

        yadm commit -m "$commit_msg"
        yadm push
    )
}

yadm_update
